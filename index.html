<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Samuriding TaskBoard - ãƒãƒ¼ãƒ ã‚¿ã‚¹ã‚¯ç®¡ç†</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“‹</text></svg>">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Noto Sans JP','Hiragino Sans',sans-serif;background:#F8FAFC;color:#1E293B}
    ::-webkit-scrollbar{height:8px;width:8px}
    ::-webkit-scrollbar-track{background:#F1F5F9;border-radius:4px}
    ::-webkit-scrollbar-thumb{background:#CBD5E1;border-radius:4px}
    @keyframes modalIn{from{opacity:0;transform:translateY(12px) scale(.97)}to{opacity:1;transform:none}}
    @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
    @keyframes spin{to{transform:rotate(360deg)}}
    @keyframes toastIn{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:none}}
    .btn{border:none;cursor:pointer;font-family:'Noto Sans JP',sans-serif;font-weight:600;transition:all .15s}
    .btn:hover{filter:brightness(.95)}.btn:active{transform:scale(.97)}
    input,select,textarea{font-family:'Noto Sans JP',sans-serif}
    .overlay{position:fixed;inset:0;z-index:1000;display:flex;align-items:center;justify-content:center;background:rgba(15,23,42,.45);backdrop-filter:blur(4px)}
    .mbox{background:#fff;border-radius:16px;padding:32px 36px;width:min(520px,92vw);box-shadow:0 25px 60px rgba(0,0,0,.18);animation:modalIn .25s ease;max-height:90vh;overflow-y:auto}
    .mhdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px}
    .mtitle{font-size:20px;font-weight:700}
    .mclose{width:32px;height:32px;border-radius:8px;border:none;background:#F1F5F9;cursor:pointer;font-size:18px;color:#64748B;display:flex;align-items:center;justify-content:center}
    .fi{width:100%;padding:10px 14px;border-radius:10px;border:1.5px solid #E2E8F0;font-size:14px;outline:none;background:#FAFBFC}
    .fi:focus{border-color:#94A3B8}
    .fl{font-size:12px;font-weight:600;color:#64748B;margin-bottom:6px;display:block}
    .fg{margin-bottom:18px}
    .fr{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .toast{position:fixed;bottom:24px;right:24px;z-index:2000;padding:12px 20px;border-radius:12px;font-size:13px;font-weight:600;box-shadow:0 8px 24px rgba(0,0,0,.2);color:#fff;animation:toastIn .3s ease}
    .tl-row:hover{background:#FAFBFE !important}
    .tl-bar{transition:transform .15s,box-shadow .15s}.tl-bar:hover{transform:scaleY(1.12)}
    .lc:hover{box-shadow:0 2px 12px rgba(0,0,0,.06) !important}
    .sec-row{background:#F8FAFC;border-bottom:1px solid #E8ECF1}
    .err-box{max-width:560px;margin:40px auto;background:#FEE2E2;border:1px solid #FECACA;border-radius:12px;padding:20px;font-size:13px;color:#991B1B;white-space:pre-wrap;word-break:break-all}
  </style>
</head>
<body>
<div id="app"><div style="display:flex;align-items:center;justify-content:center;min-height:100vh;color:#94A3B8;font-size:14px">èª­ã¿è¾¼ã¿ä¸­...</div></div>
<script>
var SUPABASE_URL="https://gztmshxdtcjwsxkckhlt.supabase.co";
var SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd6dG1zaHhkdGNqd3N4a2NraGx0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2NTU1MzIsImV4cCI6MjA4NjIzMTUzMn0.a_cnZJyN9SbtA9ThVwZHKFqf9GGVQi8XzvclcKAntKM";
window.onerror=function(msg,src,line){var el=document.getElementById("app");if(el)el.innerHTML='<div class="err-box"><strong>ã‚¨ãƒ©ãƒ¼</strong><br>'+msg+'<br>è¡Œ:'+line+'</div>';};
(function(){
var COLORS=[{bg:"#E8F5E9",bar:"#43A047",tx:"#2E7D32"},{bg:"#E3F2FD",bar:"#1E88E5",tx:"#1565C0"},{bg:"#FFF3E0",bar:"#FB8C00",tx:"#E65100"},{bg:"#F3E5F5",bar:"#8E24AA",tx:"#6A1B9A"},{bg:"#E0F7FA",bar:"#00ACC1",tx:"#00838F"},{bg:"#FBE9E7",bar:"#F4511E",tx:"#BF360C"},{bg:"#F1F8E9",bar:"#7CB342",tx:"#558B2F"},{bg:"#EDE7F6",bar:"#5E35B1",tx:"#4527A0"}];
var SEC_COLORS=["#1E88E5","#43A047","#FB8C00","#8E24AA","#00ACC1","#F4511E","#5E35B1","#D81B60"];
var STS=[{v:"not_started",l:"æœªç€æ‰‹",c:"#9E9E9E",i:"â—‹"},{v:"in_progress",l:"é€²è¡Œä¸­",c:"#1E88E5",i:"â—"},{v:"done",l:"å®Œäº†",c:"#43A047",i:"â—"}];
var DW=36;
var S={tasks:[],members:[],sections:[],loading:true,syncing:false,lastSync:null,view:"timeline",fA:null,fS:null,fSec:null,modal:null,eTask:null,toast:null,tTimer:null,prevJSON:""};
function fmtD(d){var x=new Date(d);return(x.getMonth()+1)+"/"+x.getDate();}
function toDS(d){var x=new Date(d);return x.getFullYear()+"-"+String(x.getMonth()+1).padStart(2,"0")+"-"+String(x.getDate()).padStart(2,"0");}
function dBtw(a,b){return Math.round((new Date(b)-new Date(a))/86400000);}
function addD(d,n){var x=new Date(d);x.setDate(x.getDate()+n);return x;}
function mc(name){var i=0;for(var j=0;j<S.members.length;j++){if(S.members[j].name===name){i=j;break;}}return COLORS[i%COLORS.length];}
function esc(s){if(!s)return"";var d=document.createElement("div");d.textContent=s;return d.innerHTML;}
function escA(s){return esc(s).replace(/'/g,"&#39;").replace(/"/g,"&quot;");}
function getSt(v){for(var i=0;i<STS.length;i++){if(STS[i].v===v)return STS[i];}return STS[0];}
function showToast(msg,type){if(S.tTimer)clearTimeout(S.tTimer);S.toast={m:msg,t:type||"ok"};renderToast();S.tTimer=setTimeout(function(){S.toast=null;renderToast();},3000);}
function renderToast(){var el=document.getElementById("toast-container");if(!el){el=document.createElement("div");el.id="toast-container";document.body.appendChild(el);}el.innerHTML=S.toast?'<div class="toast" style="background:'+(S.toast.t==="err"?"#DC2626":"#1E293B")+'">'+esc(S.toast.m)+'</div>':"";}
function updateSync(){var el=document.getElementById("sync-indicator");if(!el)return;var dot=S.syncing?"background:#1E88E5;animation:pulse 1s infinite":"background:#43A047";var txt=S.syncing?"åŒæœŸä¸­...":(S.lastSync?"æœ€çµ‚åŒæœŸ "+S.lastSync:"æ¥ç¶šæ¸ˆã¿");el.innerHTML='<div style="width:7px;height:7px;border-radius:50%;'+dot+'"></div>'+txt;el.style.color=S.syncing?"#1E88E5":"#94A3B8";}
function hdrs(){return{"apikey":SUPABASE_ANON_KEY,"Authorization":"Bearer "+SUPABASE_ANON_KEY,"Content-Type":"application/json","Prefer":"return=representation"};}
function apiFetch(path,opts){return fetch(SUPABASE_URL+"/rest/v1/"+path,Object.assign({headers:hdrs()},opts||{})).then(function(r){if(!r.ok)throw new Error("API "+r.status);return r;});}
function loadData(silent){
  if(!silent)S.syncing=true;if(silent)updateSync();
  return Promise.all([apiFetch("tasks?order=start_date.asc").then(function(r){return r.json();}),apiFetch("members?order=created_at.asc").then(function(r){return r.json();}),apiFetch("sections?order=sort_order.asc,created_at.asc").then(function(r){return r.json();})]).then(function(res){
    var nj=JSON.stringify(res);S.lastSync=new Date().toLocaleTimeString("ja-JP",{hour:"2-digit",minute:"2-digit"});var changed=nj!==S.prevJSON;S.tasks=res[0];S.members=res[1];S.sections=res[2];S.prevJSON=nj;
    if(silent&&!changed){S.syncing=false;updateSync();return;}
    if(silent&&S.modal){S.syncing=false;updateSync();return;}
    S.syncing=false;S.loading=false;render();
  }).catch(function(e){if(!silent)showToast("ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ","err");console.error(e);S.syncing=false;S.loading=false;if(!silent)render();updateSync();});
}
function render(){
  var app=document.getElementById("app");if(!app)return;
  try{
    if(!SUPABASE_URL||!SUPABASE_ANON_KEY){app.innerHTML=renderSetup();return;}
    if(S.loading){app.innerHTML='<div style="min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px"><div style="width:40px;height:40px;border:3px solid #E2E8F0;border-top-color:#1E293B;border-radius:50%;animation:spin .8s linear infinite"></div><p style="color:#64748B;font-size:14px;font-weight:600">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p></div>';return;}
    var filtered=S.tasks.filter(function(t){if(S.fA&&t.assignee!==S.fA)return false;if(S.fS&&t.status!==S.fS)return false;if(S.fSec&&S.fSec!=="__none__"&&t.section_id!==S.fSec)return false;return true;});
    var cnt={not_started:0,in_progress:0,done:0};S.tasks.forEach(function(t){cnt[t.status]++;});
    var h=renderHeader(cnt)+renderToolbar()+renderFilters()+'<div style="padding:0 28px 40px">';
    if(filtered.length===0)h+=renderEmpty();else if(S.view==="timeline")h+=renderTimeline(filtered);else h+=renderList(filtered);
    h+='</div>';
    if(S.modal==="task")h+=renderTaskModal();if(S.modal==="member")h+=renderMemberModal();if(S.modal==="section")h+=renderSectionModal();
    app.innerHTML=h;
    var ti=document.getElementById("f-title");if(ti)setTimeout(function(){ti.focus();},50);
    var ni=document.getElementById("f-newmember");if(ni&&S.modal==="member")setTimeout(function(){ni.focus();},50);
    var si=document.getElementById("f-newsec");if(si&&S.modal==="section")setTimeout(function(){si.focus();},50);
  }catch(e){console.error(e);app.innerHTML='<div class="err-box"><strong>æç”»ã‚¨ãƒ©ãƒ¼</strong><br>'+esc(e.message)+'</div>';}
}
function renderSetup(){return '<div style="min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#F8FAFC,#E2E8F0)"><div style="background:#fff;border-radius:20px;padding:48px 44px;max-width:560px;width:92vw;box-shadow:0 20px 60px rgba(0,0,0,.08)"><div style="display:flex;align-items:center;gap:14px;margin-bottom:28px"><div style="width:48px;height:48px;border-radius:14px;background:#1E293B;display:flex;align-items:center;justify-content:center;font-size:24px">ğŸ“‹</div><div><h1 style="font-size:22px;font-weight:800">Samuriding</h1><p style="font-size:12px;color:#94A3B8">åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—</p></div></div><div style="background:#FFFBEB;border:1px solid #FDE68A;border-radius:12px;padding:16px 20px;margin-bottom:24px"><p style="font-size:13px;color:#92400E;font-weight:600">âš ï¸ Supabaseã®è¨­å®šãŒå¿…è¦ã§ã™</p><p style="margin-top:8px;font-size:12px;color:#A16207;line-height:1.7">SUPABASE_URL ã¨ SUPABASE_ANON_KEY ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚</p></div></div></div>';}
function renderHeader(cnt){var syncDot=S.syncing?"background:#1E88E5;animation:pulse 1s infinite":"background:#43A047";var syncTxt=S.syncing?"åŒæœŸä¸­...":(S.lastSync?"æœ€çµ‚åŒæœŸ "+S.lastSync:"æ¥ç¶šæ¸ˆã¿");var syncCol=S.syncing?"#1E88E5":"#94A3B8";var stH="";for(var i=0;i<STS.length;i++){var s=STS[i];stH+='<div style="display:flex;align-items:center;gap:4px;font-size:12px;color:#64748B"><span style="color:'+s.c+';font-size:14px">'+s.i+'</span><span style="font-weight:600">'+cnt[s.v]+'</span></div>';}return '<div style="background:#fff;border-bottom:1px solid #E8ECF1;padding:14px 28px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100"><div style="display:flex;align-items:center;gap:14px"><div style="width:36px;height:36px;border-radius:10px;background:#1E293B;display:flex;align-items:center;justify-content:center;font-size:18px">ğŸ“‹</div><div><h1 style="font-size:18px;font-weight:800;letter-spacing:-.02em">TaskBoard</h1><div id="sync-indicator" style="display:flex;align-items:center;gap:6px;font-size:11px;color:'+syncCol+';font-weight:500"><div style="width:7px;height:7px;border-radius:50%;'+syncDot+'"></div>'+syncTxt+'</div></div></div><div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap"><div style="display:flex;gap:12px;margin-right:8px">'+stH+'</div><button class="btn" onclick="window._openSec()" style="padding:8px 14px;border-radius:10px;border:1.5px solid #E2E8F0;background:#fff;font-size:13px;color:#64748B;display:flex;align-items:center;gap:5px"><span style="font-size:14px">ğŸ“</span> ã‚»ã‚¯ã‚·ãƒ§ãƒ³</button><button class="btn" onclick="window._openMember()" style="padding:8px 14px;border-radius:10px;border:1.5px solid #E2E8F0;background:#fff;font-size:13px;color:#64748B;display:flex;align-items:center;gap:5px"><span style="font-size:14px">ğŸ‘¥</span> ãƒ¡ãƒ³ãƒãƒ¼</button><button class="btn" onclick="window._openTask()" style="padding:8px 20px;border-radius:10px;background:#1E293B;color:#fff;font-size:13px;display:flex;align-items:center;gap:6px;box-shadow:0 2px 8px rgba(30,41,59,.2)"><span style="font-size:16px">+</span> ã‚¿ã‚¹ã‚¯è¿½åŠ </button></div></div>';}
function renderToolbar(){var allA=S.fA===null;var h='<div style="padding:14px 28px 6px;display:flex;align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap"><div style="display:flex;gap:6px;flex-wrap:wrap"><button class="btn" onclick="window._fA(null)" style="padding:5px 14px;border-radius:20px;font-size:12px;border:'+(allA?"2px solid #1E293B":"1.5px solid #E2E8F0")+';background:'+(allA?"#1E293B":"#fff")+';color:'+(allA?"#fff":"#64748B")+'">å…¨å“¡</button>';for(var i=0;i<S.members.length;i++){var m=S.members[i],c=COLORS[i%COLORS.length],a=S.fA===m.name;h+='<button class="btn" onclick="window._fA(\''+escA(m.name)+'\')" style="padding:5px 14px;border-radius:20px;font-size:12px;border:'+(a?"2px solid "+c.bar:"1.5px solid #E2E8F0")+';background:'+(a?c.bg:"#fff")+';color:'+(a?c.tx:"#64748B")+'">'+esc(m.name)+'</button>';}h+='</div><div style="display:flex;gap:4px;background:#E8ECF1;border-radius:10px;padding:3px">';var vs=[["timeline","ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³"],["list","ãƒªã‚¹ãƒˆ"]];for(var j=0;j<vs.length;j++){var v=vs[j],act=S.view===v[0];h+='<button class="btn" onclick="window._setV(\''+v[0]+'\')" style="padding:6px 16px;border-radius:8px;background:'+(act?"#fff":"transparent")+';box-shadow:'+(act?"0 1px 4px rgba(0,0,0,.08)":"none")+';font-size:12px;color:#1E293B">'+v[1]+'</button>';}h+='</div></div>';return h;}
function renderFilters(){var h='<div style="padding:4px 28px 12px;display:flex;gap:16px;flex-wrap:wrap;align-items:center"><div style="display:flex;gap:5px;align-items:center"><span style="font-size:10px;font-weight:700;color:#94A3B8;margin-right:2px">çŠ¶æ…‹:</span>';var allSt=[{v:null,l:"å…¨ã¦",c:"#1E293B",i:""}];for(var i=0;i<STS.length;i++)allSt.push({v:STS[i].v,l:STS[i].l,c:STS[i].c,i:STS[i].i});for(var j=0;j<allSt.length;j++){var s=allSt[j],act=S.fS===s.v,col=s.c;var oc=s.v?"window._fS('"+s.v+"')":"window._fS(null)";h+='<button class="btn" onclick="'+oc+'" style="padding:3px 10px;border-radius:14px;font-size:11px;border:'+(act?"1.5px solid "+col:"1.5px solid transparent")+';background:'+(act?(s.v?col+"18":"#1E293B10"):"#fff")+';color:'+(act?col:"#94A3B8")+'">'+(s.i?s.i+" ":"")+s.l+'</button>';}h+='</div>';if(S.sections.length>0){h+='<div style="display:flex;gap:5px;align-items:center"><span style="font-size:10px;font-weight:700;color:#94A3B8;margin-right:2px">ã‚»ã‚¯ã‚·ãƒ§ãƒ³:</span>';var allSec=S.fSec===null;h+='<button class="btn" onclick="window._fSec(null)" style="padding:3px 10px;border-radius:14px;font-size:11px;border:'+(allSec?"1.5px solid #1E293B":"1.5px solid transparent")+';background:'+(allSec?"#1E293B10":"#fff")+';color:'+(allSec?"#1E293B":"#94A3B8")+'">å…¨ã¦</button>';for(var k=0;k<S.sections.length;k++){var sec=S.sections[k],actS=S.fSec===sec.id;h+='<button class="btn" onclick="window._fSec(\''+escA(sec.id)+'\')" style="padding:3px 10px;border-radius:14px;font-size:11px;border:'+(actS?"1.5px solid "+sec.color:"1.5px solid transparent")+';background:'+(actS?sec.color+"18":"#fff")+';color:'+(actS?sec.color:"#94A3B8")+'">'+esc(sec.name)+'</button>';}h+='</div>';}h+='</div>';return h;}
function renderEmpty(){var none=S.tasks.length===0;return '<div style="text-align:center;padding:80px 20px;animation:fadeIn .4s ease"><div style="font-size:48px;margin-bottom:16px">ğŸ“</div><p style="font-size:16px;font-weight:600;color:#64748B;margin-bottom:6px">'+(none?"ã‚¿ã‚¹ã‚¯ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“":"è©²å½“ã™ã‚‹ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“")+'</p><p style="font-size:13px;color:#94A3B8">'+(none?"ã€Œ+ ã‚¿ã‚¹ã‚¯è¿½åŠ ã€ã‹ã‚‰ã‚¿ã‚¹ã‚¯ã‚’ä½œæˆã—ã¾ã—ã‚‡ã†":"ãƒ•ã‚£ãƒ«ã‚¿ã‚’å¤‰æ›´ã—ã¦ã¿ã¦ãã ã•ã„")+'</p></div>';}
function renderTimeline(tasks){
  var allDt=[];for(var i=0;i<tasks.length;i++){allDt.push(new Date(tasks[i].start_date).getTime());allDt.push(new Date(tasks[i].due_date).getTime());}
  var minD=new Date(Math.min.apply(null,allDt)),maxD=new Date(Math.max.apply(null,allDt));var start=addD(minD,-3),end=addD(maxD,3),total=dBtw(start,end)+1,todayOff=dBtw(start,new Date());
  var months=[],d=new Date(start),lastM=-1;while(d<=end){if(d.getMonth()!==lastM){lastM=d.getMonth();months.push({l:d.getFullYear()+"å¹´"+(d.getMonth()+1)+"æœˆ",s:0});}months[months.length-1].s++;d=addD(d,1);}
  var mH="";for(i=0;i<months.length;i++){var m=months[i];mH+='<div style="width:'+(m.s*DW)+'px;min-width:'+(m.s*DW)+'px;padding:10px 12px;font-size:12px;font-weight:700;color:#475569;border-right:1px solid #F1F5F9">'+m.l+'</div>';}
  var dH="";for(i=0;i<total;i++){var dd=addD(start,i),we=dd.getDay()===0||dd.getDay()===6,td=toDS(dd)===toDS(new Date());dH+='<div style="width:'+DW+'px;min-width:'+DW+'px;text-align:center;padding:6px 0;font-size:10px;font-weight:'+(td?800:500)+';color:'+(td?"#1E88E5":we?"#CBD5E1":"#94A3B8")+';background:'+(td?"#E3F2FD":"transparent")+';border-radius:'+(td?6:0)+'px">'+dd.getDate()+'</div>';}
  var groups=[];for(var si=0;si<S.sections.length;si++){var sec=S.sections[si];var secTasks=tasks.filter(function(t){return t.section_id===sec.id;});if(secTasks.length>0)groups.push({section:sec,tasks:secTasks});}
  var noSec=tasks.filter(function(t){return !t.section_id;});if(noSec.length>0)groups.push({section:{id:null,name:"æœªåˆ†é¡",color:"#94A3B8"},tasks:noSec});
  var rH="";
  for(var gi=0;gi<groups.length;gi++){
    var g=groups[gi],sec2=g.section,gTasks=g.tasks;var secDone=gTasks.filter(function(t){return t.status==="done";}).length;var secProg=gTasks.length>0?Math.round(secDone/gTasks.length*100):0;
    rH+='<div class="sec-row" style="display:flex"><div style="width:240px;min-width:240px;padding:10px 16px;border-right:1px solid #E2E8F0;display:flex;align-items:center;gap:10px"><div style="width:4px;height:24px;border-radius:2px;background:'+sec2.color+'"></div><div style="flex:1;min-width:0"><div style="font-size:13px;font-weight:700;color:#1E293B;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+esc(sec2.name)+'</div><div style="display:flex;align-items:center;gap:8px;margin-top:3px"><div style="flex:1;max-width:80px;height:4px;background:#E8ECF1;border-radius:2px;overflow:hidden"><div style="height:100%;width:'+secProg+'%;background:'+sec2.color+';border-radius:2px"></div></div><span style="font-size:10px;color:#94A3B8;font-weight:600">'+secDone+'/'+gTasks.length+'</span></div></div></div><div style="flex:1;height:44px;position:relative">';
    for(var wb=0;wb<total;wb++){var wdd=addD(start,wb);if(wdd.getDay()===0||wdd.getDay()===6)rH+='<div style="position:absolute;left:'+(wb*DW)+'px;top:0;width:'+DW+'px;height:100%;background:#F1F5F9"></div>';}
    if(todayOff>=0&&todayOff<total)rH+='<div style="position:absolute;left:'+(todayOff*DW+DW/2)+'px;top:0;width:2px;height:100%;background:#1E88E5;opacity:.2;z-index:1"></div>';
    rH+='</div></div>';
    var sorted=gTasks.slice().sort(function(a,b){return new Date(a.start_date)-new Date(b.start_date);});
    for(var ti2=0;ti2<sorted.length;ti2++){
      var t=sorted[ti2],c=mc(t.assignee),sOff=dBtw(start,t.start_date),dur=dBtw(t.start_date,t.due_date)+1,st=getSt(t.status),over=new Date(t.due_date)<new Date()&&t.status!=="done",barW=Math.max(dur*DW-4,20);
      var wB="";for(var wi=0;wi<total;wi++){var wd=addD(start,wi);if(wd.getDay()===0||wd.getDay()===6)wB+='<div style="position:absolute;left:'+(wi*DW)+'px;top:0;width:'+DW+'px;height:100%;background:#FAFBFC"></div>';}
      var tL="";if(todayOff>=0&&todayOff<total)tL='<div style="position:absolute;left:'+(todayOff*DW+DW/2)+'px;top:0;width:2px;height:100%;background:#1E88E5;opacity:.3;z-index:1"></div>';
      var dLabel=dur*DW>80?'<span style="opacity:.95">'+fmtD(t.start_date)+' â€“ '+fmtD(t.due_date)+'</span>':"";
      rH+='<div class="tl-row" style="display:flex;border-bottom:1px solid #F8FAFC;cursor:pointer" onclick="window._editT(\''+escA(t.id)+'\')">';
      rH+='<div style="width:240px;min-width:240px;padding:8px 16px 8px 36px;border-right:1px solid #F1F5F9;display:flex;align-items:center;gap:8px"><span style="font-size:11px;color:'+st.c+'">'+st.i+'</span><div style="flex:1;min-width:0"><div style="font-size:12px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;text-decoration:'+(t.status==="done"?"line-through":"none")+';opacity:'+(t.status==="done"?.5:1)+'">'+esc(t.title)+'</div><div style="display:flex;align-items:center;gap:4px;margin-top:2px"><span style="font-size:10px;font-weight:600;color:'+c.tx+';background:'+c.bg+';padding:0 7px;border-radius:8px;line-height:18px">'+esc(t.assignee)+'</span>'+(over?'<span style="font-size:8px;font-weight:700;color:#DC2626;background:#FEE2E2;padding:0 5px;border-radius:6px;line-height:16px">è¶…é</span>':"")+'</div></div></div>';
      rH+='<div style="position:relative;flex:1;height:52px">'+wB+tL+'<div class="tl-bar" style="position:absolute;left:'+(sOff*DW+2)+'px;top:12px;height:28px;width:'+barW+'px;background:'+(t.status==="done"?c.bar+"40":c.bar)+';border-radius:8px;display:flex;align-items:center;padding-left:10px;font-size:11px;font-weight:600;color:#fff;overflow:hidden;white-space:nowrap;z-index:2;box-shadow:0 2px 6px '+c.bar+'30">'+dLabel+'</div></div></div>';
    }
  }
  return '<div style="background:#fff;border-radius:16px;border:1px solid #E8ECF1;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,.04);animation:fadeIn .3s ease"><div style="overflow-x:auto"><div style="min-width:'+(total*DW+240)+'px"><div style="display:flex;border-bottom:1px solid #F1F5F9"><div style="width:240px;min-width:240px;border-right:1px solid #F1F5F9;padding:10px 16px;font-size:11px;font-weight:700;color:#94A3B8">ã‚»ã‚¯ã‚·ãƒ§ãƒ³ / ã‚¿ã‚¹ã‚¯</div><div style="display:flex;flex:1">'+mH+'</div></div><div style="display:flex;border-bottom:1px solid #E8ECF1"><div style="width:240px;min-width:240px;border-right:1px solid #F1F5F9"></div><div style="display:flex">'+dH+'</div></div>'+rH+'</div></div></div>';
}
function renderList(tasks){
  var groups=[];for(var si=0;si<S.sections.length;si++){var sec=S.sections[si];var st=tasks.filter(function(t){return t.section_id===sec.id;});if(st.length>0)groups.push({section:sec,tasks:st});}
  var noSec=tasks.filter(function(t){return !t.section_id;});if(noSec.length>0)groups.push({section:{id:null,name:"æœªåˆ†é¡",color:"#94A3B8"},tasks:noSec});
  var h='<div style="display:flex;flex-direction:column;gap:16px;animation:fadeIn .3s ease">';
  for(var gi=0;gi<groups.length;gi++){
    var g=groups[gi],sec2=g.section;var secDone=g.tasks.filter(function(t){return t.status==="done";}).length;var secProg=g.tasks.length>0?Math.round(secDone/g.tasks.length*100):0;
    h+='<div><div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;padding:0 4px"><div style="width:4px;height:20px;border-radius:2px;background:'+sec2.color+'"></div><span style="font-size:14px;font-weight:700">'+esc(sec2.name)+'</span><div style="display:flex;align-items:center;gap:6px"><div style="width:60px;height:4px;background:#E8ECF1;border-radius:2px;overflow:hidden"><div style="height:100%;width:'+secProg+'%;background:'+sec2.color+';border-radius:2px"></div></div><span style="font-size:10px;color:#94A3B8;font-weight:600">'+secDone+'/'+g.tasks.length+'</span></div></div><div style="display:flex;flex-direction:column;gap:6px">';
    var sorted=g.tasks.slice().sort(function(a,b){return new Date(a.due_date)-new Date(b.due_date);});
    for(var i=0;i<sorted.length;i++){var t=sorted[i],c=mc(t.assignee),sst=getSt(t.status),over=new Date(t.due_date)<new Date()&&t.status!=="done";
      h+='<div class="lc" onclick="window._editT(\''+escA(t.id)+'\')" style="background:#fff;border-radius:12px;padding:14px 18px;border:1px solid #E8ECF1;cursor:pointer;display:flex;align-items:center;gap:14px;transition:all .15s;box-shadow:0 1px 3px rgba(0,0,0,.03)"><div style="width:28px;height:28px;border-radius:8px;background:'+sst.c+'18;display:flex;align-items:center;justify-content:center;font-size:14px;color:'+sst.c+';flex-shrink:0">'+sst.i+'</div><div style="flex:1;min-width:0"><div style="font-size:13px;font-weight:600;text-decoration:'+(t.status==="done"?"line-through":"none")+';opacity:'+(t.status==="done"?.5:1)+';overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+esc(t.title)+'</div></div><span style="font-size:10px;font-weight:600;color:'+c.tx+';background:'+c.bg+';padding:3px 10px;border-radius:16px;flex-shrink:0">'+esc(t.assignee)+'</span><div style="text-align:right;flex-shrink:0"><div style="font-size:11px;font-weight:600;color:'+(over?"#DC2626":"#64748B")+'">'+fmtD(t.start_date)+' â€“ '+fmtD(t.due_date)+'</div>'+(over?'<div style="font-size:8px;color:#DC2626;font-weight:700;margin-top:2px">æœŸé™è¶…é</div>':'')+'</div></div>';}
    h+='</div></div>';}
  h+='</div>';return h;
}
function renderTaskModal(){
  var t=S.eTask,today=toDS(new Date()),week=toDS(addD(new Date(),7));
  var title=t?t.title:"",assignee=t?t.assignee:(S.members.length>0?S.members[0].name:""),sd=t?t.start_date:today,dd2=t?t.due_date:week,status=t?t.status:"not_started",desc=t?(t.description||""):"",secId=t?(t.section_id||""):"";
  var mO="";for(var i=0;i<S.members.length;i++){var mm=S.members[i];mO+='<option value="'+escA(mm.name)+'"'+(mm.name===assignee?" selected":"")+'>'+esc(mm.name)+'</option>';}
  var sO="";for(var j=0;j<STS.length;j++){var s=STS[j];sO+='<option value="'+s.v+'"'+(s.v===status?" selected":"")+'>'+s.i+' '+s.l+'</option>';}
  var secO='<option value=""'+(secId===""?" selected":"")+'>ï¼ˆæœªåˆ†é¡ï¼‰</option>';for(var k=0;k<S.sections.length;k++){var sec=S.sections[k];secO+='<option value="'+escA(sec.id)+'"'+(sec.id===secId?" selected":"")+'>'+esc(sec.name)+'</option>';}
  var del=t?'<button class="btn" onclick="window._delT(\''+escA(t.id)+'\')" style="padding:10px 18px;border-radius:10px;background:#FEE2E2;color:#DC2626;font-size:13px;margin-right:auto">å‰Šé™¤</button>':"";
  return '<div class="overlay" onclick="window._closeM()"><div class="mbox" onclick="event.stopPropagation()"><div class="mhdr"><h2 class="mtitle">'+(t?"ã‚¿ã‚¹ã‚¯ã‚’ç·¨é›†":"æ–°ã—ã„ã‚¿ã‚¹ã‚¯")+'</h2><button class="mclose" onclick="window._closeM()">Ã—</button></div><div class="fg"><label class="fl">ã‚¿ã‚¹ã‚¯å *</label><input class="fi" id="f-title" value="'+escA(title)+'" placeholder="ä¾‹ï¼šãƒ‡ã‚¶ã‚¤ãƒ³ãƒ¬ãƒ“ãƒ¥ãƒ¼"></div><div class="fg"><label class="fl">ã‚»ã‚¯ã‚·ãƒ§ãƒ³</label><select class="fi" id="f-section">'+secO+'</select></div><div class="fr fg"><div><label class="fl">æ‹…å½“è€…</label><select class="fi" id="f-assignee">'+mO+'</select></div><div><label class="fl">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label><select class="fi" id="f-status">'+sO+'</select></div></div><div class="fr fg"><div><label class="fl">é–‹å§‹æ—¥</label><input type="date" class="fi" id="f-start" value="'+sd+'"></div><div><label class="fl">æœŸæ—¥</label><input type="date" class="fi" id="f-due" value="'+dd2+'"></div></div><div class="fg"><label class="fl">ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label><textarea class="fi" id="f-desc" rows="2" placeholder="è£œè¶³äº‹é …ãŒã‚ã‚Œã°...">'+esc(desc)+'</textarea></div><div style="display:flex;gap:10px;justify-content:flex-end;margin-top:8px">'+del+'<button class="btn" onclick="window._closeM()" style="padding:10px 22px;border-radius:10px;border:1.5px solid #E2E8F0;background:#fff;color:#64748B;font-size:13px">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button class="btn" id="btn-save" onclick="window._saveT()" style="padding:10px 28px;border-radius:10px;background:#1E293B;color:#fff;font-size:13px">'+(t?"æ›´æ–°":"ä½œæˆ")+'</button></div></div></div>';
}
function renderMemberModal(){var ch="";for(var i=0;i<S.members.length;i++){var m=S.members[i],c=COLORS[i%COLORS.length];ch+='<div style="display:flex;align-items:center;gap:6px;background:'+c.bg+';padding:6px 10px 6px 14px;border-radius:20px;font-size:13px;font-weight:600;color:'+c.tx+'"><span>'+esc(m.name)+'</span><button class="btn" onclick="window._rmM(\''+escA(m.id)+'\')" style="width:20px;height:20px;border-radius:50%;background:rgba(0,0,0,.08);font-size:12px;display:flex;align-items:center;justify-content:center;color:'+c.tx+';padding:0">Ã—</button></div>';}return '<div class="overlay" onclick="window._closeM()"><div class="mbox" onclick="event.stopPropagation()"><div class="mhdr"><h2 class="mtitle">ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†</h2><button class="mclose" onclick="window._closeM()">Ã—</button></div><div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:20px">'+ch+'</div><div style="display:flex;gap:8px"><input class="fi" id="f-newmember" placeholder="æ–°ã—ã„ãƒ¡ãƒ³ãƒãƒ¼å" onkeydown="if(event.key===\'Enter\')window._addM()" style="flex:1"><button class="btn" onclick="window._addM()" style="padding:10px 20px;border-radius:10px;background:#1E293B;color:#fff;font-size:13px;white-space:nowrap">è¿½åŠ </button></div></div></div>';}
function renderSectionModal(){
  var items="";for(var i=0;i<S.sections.length;i++){var sec=S.sections[i];var tCount=S.tasks.filter(function(t){return t.section_id===sec.id;}).length;items+='<div style="display:flex;align-items:center;gap:10px;padding:10px 14px;background:#FAFBFC;border-radius:10px;border:1px solid #F1F5F9"><div style="width:4px;height:28px;border-radius:2px;background:'+sec.color+';flex-shrink:0"></div><div style="flex:1;min-width:0"><div style="font-size:13px;font-weight:600">'+esc(sec.name)+'</div><div style="font-size:10px;color:#94A3B8;margin-top:1px">'+tCount+' ã‚¿ã‚¹ã‚¯</div></div><button class="btn" onclick="window._rmSec(\''+escA(sec.id)+'\')" style="width:24px;height:24px;border-radius:6px;background:#FEE2E2;font-size:12px;display:flex;align-items:center;justify-content:center;color:#DC2626;padding:0;flex-shrink:0">Ã—</button></div>';}
  var colorBtns="";for(var ci=0;ci<SEC_COLORS.length;ci++){colorBtns+='<button class="btn" onclick="document.getElementById(\'f-seccolor\').value=\''+SEC_COLORS[ci]+'\';this.parentNode.querySelectorAll(\'button\').forEach(function(b){b.style.outline=\'none\'});this.style.outline=\'3px solid #1E293B\'" style="width:28px;height:28px;border-radius:50%;background:'+SEC_COLORS[ci]+';padding:0'+(ci===0?';outline:3px solid #1E293B':'')+'"></button>';}
  return '<div class="overlay" onclick="window._closeM()"><div class="mbox" onclick="event.stopPropagation()"><div class="mhdr"><h2 class="mtitle">ã‚»ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†</h2><button class="mclose" onclick="window._closeM()">Ã—</button></div><div style="display:flex;flex-direction:column;gap:8px;margin-bottom:20px;max-height:240px;overflow-y:auto">'+(items||'<p style="font-size:13px;color:#94A3B8;text-align:center;padding:16px">ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“</p>')+'</div><div style="border-top:1px solid #F1F5F9;padding-top:16px"><p style="font-size:12px;font-weight:600;color:#64748B;margin-bottom:10px">æ–°ã—ã„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ </p><div style="display:flex;gap:8px;margin-bottom:10px;align-items:center"><input class="fi" id="f-newsec" placeholder="ã‚»ã‚¯ã‚·ãƒ§ãƒ³å" onkeydown="if(event.key===\'Enter\')window._addSec()" style="flex:1"><input type="hidden" id="f-seccolor" value="'+SEC_COLORS[0]+'"><button class="btn" onclick="window._addSec()" style="padding:10px 20px;border-radius:10px;background:#1E293B;color:#fff;font-size:13px;white-space:nowrap">è¿½åŠ </button></div><div style="display:flex;gap:6px;align-items:center"><span style="font-size:11px;color:#94A3B8;margin-right:4px">è‰²:</span>'+colorBtns+'</div></div></div></div>';
}
window._openTask=function(){S.eTask=null;S.modal="task";render();};
window._editT=function(id){for(var i=0;i<S.tasks.length;i++){if(S.tasks[i].id===id){S.eTask=S.tasks[i];break;}}S.modal="task";render();};
window._openMember=function(){S.modal="member";render();};
window._openSec=function(){S.modal="section";render();};
window._closeM=function(){S.modal=null;S.eTask=null;render();};
window._setV=function(v){S.view=v;render();};
window._fA=function(v){S.fA=S.fA===v?null:v;render();};
window._fS=function(v){S.fS=S.fS===v?null:v;render();};
window._fSec=function(v){S.fSec=S.fSec===v?null:v;render();};
window._saveT=function(){var el=document.getElementById("f-title");var title=el?el.value.trim():"";if(!title)return;var secVal=document.getElementById("f-section").value;var p={title:title,assignee:document.getElementById("f-assignee").value,start_date:document.getElementById("f-start").value,due_date:document.getElementById("f-due").value,status:document.getElementById("f-status").value,description:document.getElementById("f-desc").value,section_id:secVal||null};var btn=document.getElementById("btn-save");if(btn){btn.textContent="ä¿å­˜ä¸­...";btn.disabled=true;}var pr=S.eTask?apiFetch("tasks?id=eq."+S.eTask.id,{method:"PATCH",body:JSON.stringify(Object.assign(p,{updated_at:new Date().toISOString()}))}):apiFetch("tasks",{method:"POST",body:JSON.stringify(p)});pr.then(function(){showToast(S.eTask?"ã‚¿ã‚¹ã‚¯ã‚’æ›´æ–°ã—ã¾ã—ãŸ":"ã‚¿ã‚¹ã‚¯ã‚’ä½œæˆã—ã¾ã—ãŸ");S.modal=null;S.eTask=null;return loadData(true);}).catch(function(e){showToast("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ","err");console.error(e);render();});};
window._delT=function(id){apiFetch("tasks?id=eq."+id,{method:"DELETE"}).then(function(){showToast("ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã—ãŸ");S.modal=null;S.eTask=null;return loadData(true);}).catch(function(e){showToast("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ","err");console.error(e);});};
window._addM=function(){var inp=document.getElementById("f-newmember");var name=inp?inp.value.trim():"";if(!name)return;for(var i=0;i<S.members.length;i++){if(S.members[i].name===name)return;}apiFetch("members",{method:"POST",body:JSON.stringify({name:name})}).then(function(){showToast(name+" ã‚’è¿½åŠ ã—ã¾ã—ãŸ");return loadData(true);}).then(function(){S.modal="member";render();}).catch(function(e){showToast("è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ","err");console.error(e);});};
window._rmM=function(id){apiFetch("members?id=eq."+id,{method:"DELETE"}).then(function(){showToast("ãƒ¡ãƒ³ãƒãƒ¼ã‚’å‰Šé™¤ã—ã¾ã—ãŸ");return loadData(true);}).then(function(){S.modal="member";render();}).catch(function(e){showToast("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ","err");console.error(e);});};
window._addSec=function(){var inp=document.getElementById("f-newsec");var name=inp?inp.value.trim():"";if(!name)return;var color=document.getElementById("f-seccolor").value||SEC_COLORS[0];var order=S.sections.length;apiFetch("sections",{method:"POST",body:JSON.stringify({name:name,color:color,sort_order:order})}).then(function(){showToast(name+" ã‚’è¿½åŠ ã—ã¾ã—ãŸ");return loadData(true);}).then(function(){S.modal="section";render();}).catch(function(e){showToast("è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ","err");console.error(e);});};
window._rmSec=function(id){apiFetch("sections?id=eq."+id,{method:"DELETE"}).then(function(){showToast("ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤ã—ã¾ã—ãŸ");return loadData(true);}).then(function(){S.modal="section";render();}).catch(function(e){showToast("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ","err");console.error(e);});};
if(SUPABASE_URL&&SUPABASE_ANON_KEY){loadData(false);setInterval(function(){loadData(true);},5000);}else{S.loading=false;render();}
})();
</script>
</body>
</html>
