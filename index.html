<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TaskBoard - „ÉÅ„Éº„É†„Çø„Çπ„ÇØÁÆ°ÁêÜ</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìã</text></svg>">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Noto Sans JP','Hiragino Sans',sans-serif;background:#F8FAFC;color:#1E293B;transition:background .25s,color .25s}
    ::-webkit-scrollbar{height:8px;width:8px}
    ::-webkit-scrollbar-track{background:#F1F5F9;border-radius:4px}
    ::-webkit-scrollbar-thumb{background:#CBD5E1;border-radius:4px}
    @keyframes modalIn{from{opacity:0;transform:translateY(12px) scale(.97)}to{opacity:1;transform:none}}
    @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
    @keyframes spin{to{transform:rotate(360deg)}}
    @keyframes toastIn{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:none}}
    .btn{border:none;cursor:pointer;font-family:'Noto Sans JP',sans-serif;font-weight:600;transition:all .15s}
    .btn:hover{filter:brightness(.95)}.btn:active{transform:scale(.97)}
    input,select,textarea{font-family:'Noto Sans JP',sans-serif}
    .overlay{position:fixed;inset:0;z-index:1000;display:flex;align-items:center;justify-content:center;background:rgba(15,23,42,.45);backdrop-filter:blur(4px)}
    .mbox{background:#fff;border-radius:16px;padding:32px 36px;width:min(520px,92vw);box-shadow:0 25px 60px rgba(0,0,0,.18);animation:modalIn .25s ease;max-height:90vh;overflow-y:auto}
    .mhdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px}
    .mtitle{font-size:20px;font-weight:700}
    .mclose{width:32px;height:32px;border-radius:8px;border:none;background:#F1F5F9;cursor:pointer;font-size:18px;color:#64748B;display:flex;align-items:center;justify-content:center}
    .fi{width:100%;padding:10px 14px;border-radius:10px;border:1.5px solid #E2E8F0;font-size:14px;outline:none;background:#FAFBFC}
    .fi:focus{border-color:#94A3B8}
    .fl{font-size:12px;font-weight:600;color:#64748B;margin-bottom:6px;display:block}
    .fg{margin-bottom:18px}
    .fr{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .toast{position:fixed;bottom:24px;right:24px;z-index:2000;padding:12px 20px;border-radius:12px;font-size:13px;font-weight:600;box-shadow:0 8px 24px rgba(0,0,0,.2);color:#fff;animation:toastIn .3s ease}
    .tl-row:hover{background:#FAFBFE !important}
    .tl-bar{transition:transform .15s,box-shadow .15s}.tl-bar:hover{transform:scaleY(1.15)}
    .lc:hover{box-shadow:0 2px 12px rgba(0,0,0,.06) !important}
    .sec-row{background:#F8FAFC;border-bottom:1px solid #E8ECF1}
    .err-box{max-width:560px;margin:40px auto;background:#FEE2E2;border:1px solid #FECACA;border-radius:12px;padding:20px;font-size:13px;color:#991B1B;white-space:pre-wrap;word-break:break-all}
    .gantt-area{cursor:crosshair;position:relative}
    .gantt-area:hover .gantt-hint{opacity:1}
    .gantt-hint{position:absolute;top:50%;transform:translateY(-50%);pointer-events:none;opacity:0;transition:opacity .2s;background:#1E293B;color:#fff;font-size:10px;font-weight:600;padding:3px 10px;border-radius:6px;white-space:nowrap;z-index:5}
    .empty-sec-row{border-bottom:1px solid #F1F5F9}
    .empty-sec-row:hover{background:#F8FAFC}
    .add-task-hint{opacity:0;transition:opacity .15s;font-size:11px;color:#94A3B8;display:flex;align-items:center;gap:4px}
    .empty-sec-row:hover .add-task-hint{opacity:1}
    /* ‚òÖ „Ç¨„É≥„Éà„ÉÅ„É£„Éº„ÉàÂúüÊó•„Ç´„É©„É†Áî®„ÇØ„É©„Çπ */
    .we-a{background:#F1F5F9}.we-b{background:#FAFBFC}
    /* ‚òÖ „ÉÄ„Éº„ÇØ„É¢„Éº„Éâ„Éà„Ç∞„É´ */
    .dm-sw{width:44px;height:24px;border-radius:12px;border:none;cursor:pointer;position:relative;background:#CBD5E1;padding:0;flex-shrink:0;transition:background .3s}
    .dm-sw .dm-k{width:18px;height:18px;border-radius:50%;background:#fff;position:absolute;top:3px;left:3px;transition:transform .3s;box-shadow:0 1px 3px rgba(0,0,0,.2)}
    .dm-sw .dm-i{position:absolute;top:50%;transform:translateY(-50%);font-size:12px;transition:opacity .3s}
    .dm-sun{left:5px;opacity:1}.dm-moon{right:5px;opacity:0}
    body.dark .dm-sw{background:#475569}
    body.dark .dm-sw .dm-k{transform:translateX(20px)}
    body.dark .dm-sun{opacity:0}body.dark .dm-moon{opacity:1}
    /* ‚òÖ‚òÖ‚òÖ „ÉÄ„Éº„ÇØ„É¢„Éº„Éâ„Ç™„Éº„Éê„Éº„É©„Ç§„Éâ ‚òÖ‚òÖ‚òÖ */
    body.dark{background:#0F172A;color:#E2E8F0}
    body.dark ::-webkit-scrollbar-track{background:#1E293B}
    body.dark ::-webkit-scrollbar-thumb{background:#475569}
    body.dark .overlay{background:rgba(0,0,0,.6)}
    body.dark .mbox{background:#1E293B !important;color:#E2E8F0;box-shadow:0 25px 60px rgba(0,0,0,.5)}
    body.dark .mtitle{color:#E2E8F0}
    body.dark .mclose{background:#334155;color:#94A3B8}
    body.dark .fi{background:#0F172A !important;border-color:#334155 !important;color:#E2E8F0 !important}
    body.dark .fi:focus{border-color:#64748B !important}
    body.dark .fl{color:#94A3B8}
    body.dark .sec-row{background:#172033 !important;border-color:#334155 !important;color:#E2E8F0 !important}
    body.dark .sec-row *{color:#E2E8F0 !important}
    body.dark .sec-row span[style*="color:#94A3B8"]{color:#64748B !important}
    body.dark .sec-row div[style*="background:#E8ECF1"]{background:#334155 !important}
    body.dark .tl-row:hover{background:#253045 !important}
    body.dark .lc:hover{box-shadow:0 2px 12px rgba(0,0,0,.3) !important}
    body.dark .gantt-hint{background:#E2E8F0;color:#0F172A}
    body.dark .empty-sec-row{border-color:#253045 !important}
    body.dark .empty-sec-row:hover{background:#172033 !important}
    body.dark .add-task-hint{color:#64748B}
    body.dark .we-a{background:#182338 !important}.we-b{background:#FAFBFC}
    body.dark .we-b{background:#162035 !important}
    body.dark .err-box{background:#451A1A;border-color:#7F1D1D;color:#FCA5A5}
    /* „Éò„ÉÉ„ÉÄ„Éº„Éª„Ç´„Éº„Éâ„Éª„Éë„Éç„É´Ôºàinline style‰∏äÊõ∏„ÅçÔºâ */
    body.dark [data-hd]{background:#1E293B !important;border-color:#334155 !important}
    body.dark [data-hd] h1{color:#E2E8F0 !important}
    body.dark [data-hd] span[style*="font-weight:600"]{color:#E2E8F0 !important}
    body.dark [data-card]{background:#1E293B !important;border-color:#334155 !important}
    body.dark [data-tl]{background:#1E293B !important;border-color:#334155 !important}
    body.dark [data-al]{background:#422006 !important;border-color:#854D0E !important}
    body.dark [data-al] span{color:#FDE68A !important}
    /* „Éú„Éº„ÉÄ„ÉºÁ≥ª */
    body.dark [data-bd]{border-color:#334155 !important}
    body.dark [data-bdl]{border-color:#253045 !important}
    /* „Éú„Çø„É≥Á≥ª */
    body.dark [data-btn-n]{background:#1E293B !important;border-color:#334155 !important;color:#94A3B8 !important}
    body.dark [data-btn-a]{background:#E2E8F0 !important;color:#0F172A !important}
    body.dark [data-vt] [data-vt-a]{background:#0F172A !important}
    body.dark [data-vt]{background:#334155 !important}
    /* „ÉÜ„Ç≠„Çπ„ÉàÁ≥ª */
    body.dark [data-tx]{color:#E2E8F0 !important}
    body.dark [data-txs]{color:#94A3B8 !important}
    body.dark [data-txm]{color:#64748B !important}
    body.dark [data-txf]{color:#475569 !important}
    /* „É™„Çπ„Éà„Éì„É•„Éº „Çª„ÇØ„Ç∑„Éß„É≥ÈÄ≤Êçó„Éê„ÉºËÉåÊôØ */
    body.dark div[style*="background:#E8ECF1"]{background:#334155 !important}
    /* „É™„Çπ„Éà„Éì„É•„Éº „Çª„ÇØ„Ç∑„Éß„É≥„Éò„ÉÉ„ÉÄ„Éº */
    body.dark [data-sec-hd] span{color:#E2E8F0 !important}
    body.dark [data-sec-hd] span[style*="color:#94A3B8"]{color:#64748B !important}
    /* „É™„Çπ„Éà„Éì„É•„Éº Êó•‰ªò„ÉÜ„Ç≠„Çπ„Éà */
    body.dark div[style*="color:#64748B"]{color:#94A3B8 !important}
    /* „Çø„Çπ„ÇØË°å„ÅÆÂ∑¶„Éë„Éç„É´ÂÖ®„ÉÜ„Ç≠„Çπ„Éà */
    body.dark .tl-row div[style*="color:#1E293B"]{color:#E2E8F0 !important}
    body.dark .tl-row span[style*="color:#B0B8C4"]{color:#64748B !important}
    /* „Ç¨„É≥„Éà„ÉÅ„É£„Éº„ÉàË°å */
    body.dark .tl-row{border-color:#1E293B !important}
    body.dark [data-tleft]{border-color:#334155 !important}
    body.dark [data-ga]{border-color:#253045 !important}
    /* „Éï„Ç£„É´„Çø„Éú„Çø„É≥ÈùûÊ¥ªÊÄß */
    body.dark [data-fb]{background:#1E293B !important;color:#64748B !important}
    body.dark [data-fb-a]{color:#E2E8F0 !important;background:#334155 !important;border-color:#94A3B8 !important}
    /* „É≠„ÉÉ„ÇØ„É¢„Éº„ÉÄ„É´ */
    body.dark [data-lock-bg]{background:#334155 !important}
    body.dark [data-del-bg]{background:#7F1D1D !important}
    /* „É≠„Ç∞„Ç§„É≥ÁîªÈù¢ */
    body.dark [data-app-lock]{background:linear-gradient(135deg,#0F172A,#1E293B) !important}
  </style>
</head>
<body>
<div id="app"><div style="display:flex;align-items:center;justify-content:center;min-height:100vh;color:#94A3B8;font-size:14px">Ë™≠„ÅøËæº„Åø‰∏≠...</div></div>
<script>
var SUPABASE_URL="https://gztmshxdtcjwsxkckhlt.supabase.co";
var SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd6dG1zaHhkdGNqd3N4a2NraGx0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2NTU1MzIsImV4cCI6MjA4NjIzMTUzMn0.a_cnZJyN9SbtA9ThVwZHKFqf9GGVQi8XzvclcKAntKM";
var MEMBER_PASS="M48JIe9";
var APP_PASS="N48JIe9"; // ‚òÖ „Ç¢„Éó„É™ÂÖ®‰Ωì„ÅÆ„É≠„Ç∞„Ç§„É≥„Éë„Çπ„ÉØ„Éº„ÉâÔºàÂ§âÊõ¥ÂèØËÉΩÔºâ
var LOGO_SM="data:image/jpeg;base64,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";
var LOGO_LG="data:image/jpeg;base64,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";
window.onerror=function(msg,src,line){var el=document.getElementById("app");if(el)el.innerHTML='<div class="err-box"><strong>„Ç®„É©„Éº</strong><br>'+msg+'<br>Ë°å:'+line+'</div>';};
(function(){
var COLORS=[{bg:"#E8F5E9",bar:"#43A047",tx:"#2E7D32"},{bg:"#E3F2FD",bar:"#1E88E5",tx:"#1565C0"},{bg:"#FFF3E0",bar:"#FB8C00",tx:"#E65100"},{bg:"#F3E5F5",bar:"#8E24AA",tx:"#6A1B9A"},{bg:"#E0F7FA",bar:"#00ACC1",tx:"#00838F"},{bg:"#FBE9E7",bar:"#F4511E",tx:"#BF360C"},{bg:"#F1F8E9",bar:"#7CB342",tx:"#558B2F"},{bg:"#EDE7F6",bar:"#5E35B1",tx:"#4527A0"}];
var SEC_COLORS=["#1E88E5","#43A047","#FB8C00","#8E24AA","#00ACC1","#F4511E","#5E35B1","#D81B60"];
var STS=[{v:"not_started",l:"Êú™ÁùÄÊâã",c:"#9E9E9E",i:"‚óã"},{v:"in_progress",l:"ÈÄ≤Ë°å‰∏≠",c:"#1E88E5",i:"‚óê"},{v:"done",l:"ÂÆå‰∫Ü",c:"#43A047",i:"‚óè"}];
var DW=36,LEFT_W=240;
var S={tasks:[],members:[],sections:[],loading:true,syncing:false,lastSync:null,view:"timeline",fA:null,fS:null,fSec:null,modal:null,eTask:null,toast:null,tTimer:null,prevJSON:"",
  // „Ç¨„É≥„Éà„ÉÅ„É£„Éº„Éà‰∏ä„ÇØ„É™„ÉÉ„ÇØÁî®„ÅÆ‰∏ÄÊôÇ„Éá„Éº„Çø
  clickSecId:null,clickStartDate:null,
  memberUnlocked:false,passError:false,confirmDelMember:null,
  taskComments:[],commentsLoading:false,dark:false,
  appUnlocked:false,appPassError:false,
  prevTaskCount:-1,newTaskCount:0
};
function fmtD(d){var x=new Date(d);return(x.getMonth()+1)+"/"+x.getDate();}
function toDS(d){var x=new Date(d);return x.getFullYear()+"-"+String(x.getMonth()+1).padStart(2,"0")+"-"+String(x.getDate()).padStart(2,"0");}
function dBtw(a,b){return Math.round((new Date(b)-new Date(a))/86400000);}
function addD(d,n){var x=new Date(d);x.setDate(x.getDate()+n);return x;}
function mc(name){var i=0;for(var j=0;j<S.members.length;j++){if(S.members[j].name===name){i=j;break;}}return COLORS[i%COLORS.length];}
function esc(s){if(!s)return"";var d=document.createElement("div");d.textContent=s;return d.innerHTML;}
function escA(s){return esc(s).replace(/'/g,"&#39;").replace(/"/g,"&quot;");}
function getSt(v){for(var i=0;i<STS.length;i++){if(STS[i].v===v)return STS[i];}return STS[0];}
// ‚òÖ ÊúüÈôê„Ç¢„É©„Éº„ÉàÔºöÊÆã„ÇäÊó•Êï∞„Åã„ÇâÁ∑äÊÄ•Â∫¶„ÇíÂà§ÂÆö
function getUrgency(t){
  if(t.status==="done")return{level:"done",label:"",color:""};
  var days=dBtw(toDS(new Date()),t.due_date);
  if(days<0)return{level:"overdue",label:"ÊúüÈôêË∂ÖÈÅé "+Math.abs(days)+"Êó•",color:"#DC2626",bg:"#FEE2E2"};
  if(days===0)return{level:"today",label:"Êú¨Êó•ÊúüÈôê",color:"#EA580C",bg:"#FFF7ED"};
  if(days<=2)return{level:"soon",label:"„ÅÇ„Å®"+days+"Êó•",color:"#D97706",bg:"#FFFBEB"};
  if(days<=5)return{level:"near",label:"„ÅÇ„Å®"+days+"Êó•",color:"#CA8A04",bg:"#FEFCE8"};
  return{level:"ok",label:"",color:""};
}
function loadComments(taskId){
  S.commentsLoading=true;S.taskComments=[];
  apiFetch("comments?task_id=eq."+taskId+"&order=created_at.desc").then(function(r){return r.json();}).then(function(data){S.taskComments=data;S.commentsLoading=false;renderCommentsArea();}).catch(function(e){console.error(e);S.commentsLoading=false;renderCommentsArea();});
}
function renderCommentsArea(){
  var el=document.getElementById("comments-area");if(!el)return;
  if(S.commentsLoading){el.innerHTML='<div style="text-align:center;padding:12px;font-size:12px;color:#94A3B8" data-txm>Ë™≠„ÅøËæº„Åø‰∏≠...</div>';return;}
  var h="";
  if(S.taskComments.length===0){h='<div style="text-align:center;padding:16px;font-size:12px;color:#CBD5E1" data-txf>„Ç≥„É°„É≥„Éà„ÅØ„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì</div>';}
  else{for(var i=0;i<S.taskComments.length;i++){var cm=S.taskComments[i];var d=new Date(cm.created_at);var ts=(d.getMonth()+1)+"/"+d.getDate()+" "+d.getHours()+":"+String(d.getMinutes()).padStart(2,"0");h+='<div style="padding:10px 0;border-bottom:1px solid #F1F5F9"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px"><span style="font-size:11px;font-weight:700;color:#1E293B" data-tx>'+esc(cm.author)+'</span><span style="font-size:10px;color:#CBD5E1" data-txf>'+ts+'</span></div><div style="font-size:12px;color:#64748B;line-height:1.6;white-space:pre-wrap">'+esc(cm.body)+'</div></div>';}}
  el.innerHTML=h;
}
function showToast(msg,type){if(S.tTimer)clearTimeout(S.tTimer);S.toast={m:msg,t:type||"ok"};renderToast();S.tTimer=setTimeout(function(){S.toast=null;renderToast();},3000);}
function renderToast(){var el=document.getElementById("toast-container");if(!el){el=document.createElement("div");el.id="toast-container";document.body.appendChild(el);}el.innerHTML=S.toast?'<div class="toast" style="background:'+(S.toast.t==="err"?"#DC2626":"#1E293B")+'">'+esc(S.toast.m)+'</div>':"";}
function updateSync(){var el=document.getElementById("sync-indicator");if(!el)return;var dot=S.syncing?"background:#1E88E5;animation:pulse 1s infinite":"background:#43A047";var txt=S.syncing?"ÂêåÊúü‰∏≠...":(S.lastSync?"ÊúÄÁµÇÂêåÊúü "+S.lastSync:"Êé•Á∂öÊ∏à„Åø");el.innerHTML='<div style="width:7px;height:7px;border-radius:50%;'+dot+'"></div>'+txt;el.style.color=S.syncing?"#1E88E5":"#94A3B8";}
function hdrs(){return{"apikey":SUPABASE_ANON_KEY,"Authorization":"Bearer "+SUPABASE_ANON_KEY,"Content-Type":"application/json","Prefer":"return=representation"};}
function apiFetch(path,opts){return fetch(SUPABASE_URL+"/rest/v1/"+path,Object.assign({headers:hdrs()},opts||{})).then(function(r){if(!r.ok)throw new Error("API "+r.status);return r;});}
function loadData(silent){
  if(!silent)S.syncing=true;if(silent)updateSync();
  return Promise.all([apiFetch("tasks?order=start_date.asc").then(function(r){return r.json();}),apiFetch("members?order=created_at.asc").then(function(r){return r.json();}),apiFetch("sections?order=sort_order.asc,created_at.asc").then(function(r){return r.json();})]).then(function(res){
    var nj=JSON.stringify(res);S.lastSync=new Date().toLocaleTimeString("ja-JP",{hour:"2-digit",minute:"2-digit"});var changed=nj!==S.prevJSON;
    // ‚òÖ „Çø„Çπ„ÇØËøΩÂä†Ê§úÁü•Ôºà„Çø„ÉñÈÄöÁü•Ôºâ
    var oldCount=S.prevTaskCount;var newCount=res[0].length;
    if(oldCount>=0&&newCount>oldCount&&document.hidden){S.newTaskCount+=newCount-oldCount;updateTabBadge();}
    S.prevTaskCount=newCount;
    S.tasks=res[0];S.members=res[1];S.sections=res[2];S.prevJSON=nj;
    if(silent&&!changed){S.syncing=false;updateSync();return;}
    if(silent&&S.modal){S.syncing=false;updateSync();return;}
    S.syncing=false;S.loading=false;render();
  }).catch(function(e){if(!silent)showToast("„Éá„Éº„Çø„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü","err");console.error(e);S.syncing=false;S.loading=false;if(!silent)render();updateSync();});
}

// ‚îÄ‚îÄ‚îÄ „Çø„Ç§„É†„É©„Ç§„É≥Êó•‰ªòÁØÑÂõ≤Ôºà„Ç∞„É≠„Éº„Éê„É´„Åß‰Ωø„ÅÜÔºâ ‚îÄ‚îÄ‚îÄ
var TL={start:null,total:0};

function calcTimelineRange(tasks){
  var allDt=[];
  // „Çø„Çπ„ÇØ„Åå„ÅÇ„Çå„Å∞„Åù„ÅÆÁØÑÂõ≤„Çí‰Ωø„ÅÜ
  for(var i=0;i<tasks.length;i++){allDt.push(new Date(tasks[i].start_date).getTime());allDt.push(new Date(tasks[i].due_date).getTime());}
  // „Çø„Çπ„ÇØ„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ‰ªäÊó•„Çí‰∏≠ÂøÉ„Å´ÂâçÂæå2ÈÄ±Èñì
  if(allDt.length===0){
    var now=new Date();
    allDt.push(addD(now,-14).getTime());
    allDt.push(addD(now,14).getTime());
  }
  var minD=new Date(Math.min.apply(null,allDt)),maxD=new Date(Math.max.apply(null,allDt));
  TL.start=addD(minD,-3);
  var end=addD(maxD,3);
  TL.total=dBtw(TL.start,end)+1;
  return {start:TL.start,end:end,total:TL.total};
}

// ‚òÖ „Ç¨„É≥„Éà„ÉÅ„É£„Éº„Éà„Ç®„É™„Ç¢„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„ÅüÊôÇÔºö„ÇØ„É™„ÉÉ„ÇØ‰ΩçÁΩÆ„Åã„ÇâÊó•‰ªò„ÇíÁÆóÂá∫„Åó„Å¶„Çø„Çπ„ÇØËøΩÂä†„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
window._ganttClick=function(e,secId){
  // „Éê„Éº‰∏ä„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„ÅØÁÑ°Ë¶ñÔºà„Çø„Çπ„ÇØÁ∑®ÈõÜ„ÅåÂÑ™ÂÖàÔºâ
  if(e.target.closest&&e.target.closest('.tl-bar'))return;
  var area=e.currentTarget;
  var rect=area.getBoundingClientRect();
  var x=e.clientX-rect.left;
  var dayIndex=Math.floor(x/DW);
  if(dayIndex<0)dayIndex=0;
  if(dayIndex>=TL.total)dayIndex=TL.total-1;
  var clickDate=addD(TL.start,dayIndex);
  S.clickSecId=secId||null;
  S.clickStartDate=toDS(clickDate);
  S.eTask=null;
  S.modal="task";
  render();
};

function render(){
  var app=document.getElementById("app");if(!app)return;
  try{
    // ‚òÖ „Ç¢„Éó„É™ÂÖ®‰Ωì„É≠„ÉÉ„ÇØ
    if(!S.appUnlocked){app.innerHTML=renderAppLock();var ai=document.getElementById("f-apppass");if(ai)setTimeout(function(){ai.focus();},50);return;}
    if(!SUPABASE_URL||!SUPABASE_ANON_KEY){app.innerHTML=renderSetup();return;}
    if(S.loading){app.innerHTML='<div style="min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px"><div style="width:40px;height:40px;border:3px solid #E8ECF1;border-top-color:#1E293B;border-radius:50%;animation:spin .8s linear infinite" data-bd></div><p style="color:#64748B;font-size:14px;font-weight:600" data-txs>„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...</p></div>';return;}
    var filtered=S.tasks.filter(function(t){if(S.fA&&t.assignee!==S.fA)return false;if(S.fS&&t.status!==S.fS)return false;if(S.fSec&&S.fSec!=="__none__"&&t.section_id!==S.fSec)return false;return true;});
    var cnt={not_started:0,in_progress:0,done:0};S.tasks.forEach(function(t){cnt[t.status]++;});
    var h=renderHeader(cnt)+renderAlertBanner()+renderToolbar()+renderFilters()+'<div style="padding:0 28px 40px">';
    if(S.view==="timeline")h+=renderTimeline(filtered);
    else{if(filtered.length===0)h+=renderEmpty();else h+=renderList(filtered);}
    h+='</div>';
    if(S.modal==="task")h+=renderTaskModal();if(S.modal==="member")h+=renderMemberModal();if(S.modal==="section")h+=renderSectionModal();if(S.modal==="password")h+=renderPasswordModal();if(S.confirmDelMember)h+=renderConfirmDeleteMember();
    app.innerHTML=h;
    var ti=document.getElementById("f-title");if(ti)setTimeout(function(){ti.focus();},50);
    var ni=document.getElementById("f-newmember");if(ni&&S.modal==="member")setTimeout(function(){ni.focus();},50);
    var pi=document.getElementById("f-pass");if(pi&&S.modal==="password")setTimeout(function(){pi.focus();},50);
    var si2=document.getElementById("f-newsec");if(si2&&S.modal==="section")setTimeout(function(){si2.focus();},50);
  }catch(e){console.error(e);app.innerHTML='<div class="err-box"><strong>ÊèèÁîª„Ç®„É©„Éº</strong><br>'+esc(e.message)+'</div>';}
}
function renderSetup(){return '<div style="min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#F8FAFC,#E2E8F0)"><div style="background:#fff;border-radius:20px;padding:48px 44px;max-width:560px;width:92vw;box-shadow:0 20px 60px rgba(0,0,0,.08)"><div style="display:flex;align-items:center;gap:14px;margin-bottom:28px"><div style="width:48px;height:48px;border-radius:14px;background:#1E293B;display:flex;align-items:center;justify-content:center;font-size:24px">üìã</div><div><h1 style="font-size:22px;font-weight:800">TaskBoard</h1><p style="font-size:12px;color:#94A3B8">ÂàùÊúü„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó</p></div></div><div style="background:#FFFBEB;border:1px solid #FDE68A;border-radius:12px;padding:16px 20px;margin-bottom:24px"><p style="font-size:13px;color:#92400E;font-weight:600">‚ö†Ô∏è Supabase„ÅÆË®≠ÂÆö„ÅåÂøÖË¶Å„Åß„Åô</p><p style="margin-top:8px;font-size:12px;color:#A16207;line-height:1.7">SUPABASE_URL „Å® SUPABASE_ANON_KEY „ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p></div></div></div>';}
function renderAppLock(){
  var errH=S.appPassError?'<div style="color:#DC2626;font-size:12px;font-weight:600;margin-top:10px;display:flex;align-items:center;justify-content:center;gap:4px"><span>‚ö†Ô∏è</span> „Éë„Çπ„ÉØ„Éº„Éâ„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì</div>':"";
  return '<div style="min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#F8FAFC,#E2E8F0)" data-app-lock><div data-card style="background:#fff;border-radius:24px;padding:56px 48px;max-width:420px;width:90vw;box-shadow:0 25px 80px rgba(0,0,0,.1);text-align:center;animation:fadeIn .4s ease"><img src="'+LOGO_LG+'" alt="Samuriding" style="height:48px;margin:0 auto 16px;display:block;border-radius:8px;background:#fff;padding:6px 12px"><p style="font-size:13px;margin-bottom:32px" data-txm>„ÉÅ„Éº„É†„Çø„Çπ„ÇØÁÆ°ÁêÜ</p><div style="text-align:left;margin-bottom:8px"><label class="fl">„Éë„Çπ„ÉØ„Éº„Éâ</label><input class="fi" id="f-apppass" type="password" placeholder="„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ" onkeydown="if(event.key===\'Enter\')window._appLogin()" style="text-align:center;font-size:18px;letter-spacing:6px"></div>'+errH+'<button class="btn" onclick="window._appLogin()" style="width:100%;padding:14px;border-radius:12px;background:#1E293B;color:#fff;font-size:15px;font-weight:700;margin-top:16px;box-shadow:0 4px 12px rgba(30,41,59,.2)" data-btn-a>„É≠„Ç∞„Ç§„É≥</button><p style="font-size:10px;margin-top:24px" data-txf>üîí „Ç¢„ÇØ„Çª„Çπ„Å´„ÅØ„Éë„Çπ„ÉØ„Éº„Éâ„ÅåÂøÖË¶Å„Åß„Åô</p></div></div>';
}
function renderAlertBanner(){
  var urgent=[];
  for(var i=0;i<S.tasks.length;i++){var t=S.tasks[i],u=getUrgency(t);if(u.level==="overdue"||u.level==="today"||u.level==="soon")urgent.push({task:t,urg:u});}
  if(urgent.length===0)return"";
  urgent.sort(function(a,b){return dBtw(toDS(new Date()),a.task.due_date)-dBtw(toDS(new Date()),b.task.due_date);});
  var items="";var max=Math.min(urgent.length,5);
  for(var j=0;j<max;j++){var it=urgent[j];items+='<span onclick="window._editT(\''+escA(it.task.id)+'\')" style="display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:8px;font-size:11px;font-weight:600;background:'+it.urg.bg+';color:'+it.urg.color+';cursor:pointer;white-space:nowrap"><span style="font-size:9px">'+( it.urg.level==="overdue"?"üî¥":it.urg.level==="today"?"üü†":"üü°")+'</span>'+esc(it.task.title)+' <span style="opacity:.7">'+it.urg.label+'</span></span>';}
  if(urgent.length>5)items+='<span style="font-size:11px;color:#94A3B8;font-weight:500">‰ªñ '+(urgent.length-5)+'‰ª∂</span>';
  return '<div style="padding:8px 28px;background:#FFFBEB;border-bottom:1px solid #FDE68A;display:flex;align-items:center;gap:8px;flex-wrap:wrap" data-al><span style="font-size:11px;font-weight:700;color:#92400E;display:flex;align-items:center;gap:4px;margin-right:4px;white-space:nowrap">üîî ÊúüÈôê„Ç¢„É©„Éº„Éà</span>'+items+'</div>';
}
function renderHeader(cnt){var syncDot=S.syncing?"background:#1E88E5;animation:pulse 1s infinite":"background:#43A047";var syncTxt=S.syncing?"ÂêåÊúü‰∏≠...":(S.lastSync?"ÊúÄÁµÇÂêåÊúü "+S.lastSync:"Êé•Á∂öÊ∏à„Åø");var syncCol=S.syncing?"#1E88E5":"#94A3B8";var stH="";for(var i=0;i<STS.length;i++){var s=STS[i];stH+='<div style="display:flex;align-items:center;gap:4px;font-size:12px;color:#64748B"><span style="color:'+s.c+';font-size:14px">'+s.i+'</span><span style="font-weight:600">'+cnt[s.v]+'</span></div>';}return '<div style="background:#fff;border-bottom:1px solid #E8ECF1;padding:14px 28px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100" data-hd="1"><div style="display:flex;align-items:center;gap:14px"><div><img src="'+LOGO_SM+'" alt="Samuriding" style="height:36px;display:block;border-radius:6px;background:#fff;padding:4px 8px"><div id="sync-indicator" style="display:flex;align-items:center;gap:6px;font-size:11px;color:'+syncCol+';font-weight:500"><div style="width:7px;height:7px;border-radius:50%;'+syncDot+'"></div>'+syncTxt+'</div></div></div><div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap"><div style="display:flex;gap:12px;margin-right:8px">'+stH+'</div><button class="dm-sw" onclick="window._toggleDark()" title="„ÉÄ„Éº„ÇØ„É¢„Éº„Éâ"><div class="dm-k"></div><span class="dm-i dm-sun">‚òÄÔ∏è</span><span class="dm-i dm-moon">üåô</span></button><button class="btn" onclick="window._openSec()" style="padding:8px 14px;border-radius:10px;border:1.5px solid #E2E8F0;background:#fff;font-size:13px;color:#64748B;display:flex;align-items:center;gap:5px" data-btn-n><span style="font-size:14px">üìÅ</span> „Çª„ÇØ„Ç∑„Éß„É≥</button><button class="btn" onclick="window._openMember()" style="padding:8px 14px;border-radius:10px;border:1.5px solid #E2E8F0;background:#fff;font-size:13px;color:#64748B;display:flex;align-items:center;gap:5px" data-btn-n><span style="font-size:14px">üë•</span> üîí„É°„É≥„Éê„Éº</button><button class="btn" onclick="window._openTask()" style="padding:8px 20px;border-radius:10px;background:#1E293B;color:#fff;font-size:13px;display:flex;align-items:center;gap:6px;box-shadow:0 2px 8px rgba(30,41,59,.2)" data-btn-a><span style="font-size:16px">+</span> „Çø„Çπ„ÇØËøΩÂä†</button></div></div>';}
function renderToolbar(){var allA=S.fA===null;var h='<div style="padding:14px 28px 6px;display:flex;align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap"><div style="display:flex;gap:6px;flex-wrap:wrap"><button class="btn" onclick="window._fA(null)" style="padding:5px 14px;border-radius:20px;font-size:12px;border:'+(allA?"2px solid #1E293B":"1.5px solid #E2E8F0")+';background:'+(allA?"#1E293B":"#fff")+';color:'+(allA?"#fff":"#64748B")+'"'+(allA?" data-btn-a":" data-fb")+'>ÂÖ®Âì°</button>';for(var i=0;i<S.members.length;i++){var m=S.members[i],c=COLORS[i%COLORS.length],a=S.fA===m.name;h+='<button class="btn" onclick="window._fA(\''+escA(m.name)+'\')" style="padding:5px 14px;border-radius:20px;font-size:12px;border:'+(a?"2px solid "+c.bar:"1.5px solid #E2E8F0")+';background:'+(a?c.bg:"#fff")+';color:'+(a?c.tx:"#64748B")+'"'+(a?"":" data-fb")+'>'+esc(m.name)+'</button>';}h+='</div><div style="display:flex;gap:4px;background:#E8ECF1;border-radius:10px;padding:3px" data-vt="1">';var vs=[["timeline","„Çø„Ç§„É†„É©„Ç§„É≥"],["list","„É™„Çπ„Éà"]];for(var j=0;j<vs.length;j++){var v=vs[j],act=S.view===v[0];h+='<button class="btn" onclick="window._setV(\''+v[0]+'\')" style="padding:6px 16px;border-radius:8px;background:'+(act?"#fff":"transparent")+';box-shadow:'+(act?"0 1px 4px rgba(0,0,0,.08)":"none")+';font-size:12px;color:#1E293B"'+(act?" data-vt-a":"")+' data-tx>'+v[1]+'</button>';}h+='</div></div>';return h;}
function renderFilters(){var h='<div style="padding:4px 28px 12px;display:flex;gap:16px;flex-wrap:wrap;align-items:center"><div style="display:flex;gap:5px;align-items:center"><span style="font-size:10px;font-weight:700;color:#94A3B8;margin-right:2px" data-txm>Áä∂ÊÖã:</span>';var allSt=[{v:null,l:"ÂÖ®„Å¶",c:"#1E293B",i:""}];for(var i=0;i<STS.length;i++)allSt.push({v:STS[i].v,l:STS[i].l,c:STS[i].c,i:STS[i].i});for(var j=0;j<allSt.length;j++){var s=allSt[j],act=S.fS===s.v,col=s.c;var oc=s.v?"window._fS('"+s.v+"')":"window._fS(null)";h+='<button class="btn" onclick="'+oc+'" style="padding:3px 10px;border-radius:14px;font-size:11px;border:'+(act?"1.5px solid "+col:"1.5px solid transparent")+';background:'+(act?(s.v?col+"18":"#E8ECF1"):"#fff")+';color:'+(act?col:"#94A3B8")+'"'+(act?(s.v?"":" data-fb-a"):" data-fb")+'>'+(s.i?s.i+" ":"")+s.l+'</button>';}h+='</div>';if(S.sections.length>0){h+='<div style="display:flex;gap:5px;align-items:center"><span style="font-size:10px;font-weight:700;color:#94A3B8;margin-right:2px" data-txm>„Çª„ÇØ„Ç∑„Éß„É≥:</span>';var allSec=S.fSec===null;h+='<button class="btn" onclick="window._fSec(null)" style="padding:3px 10px;border-radius:14px;font-size:11px;border:'+(allSec?"1.5px solid #1E293B":"1.5px solid transparent")+';background:'+(allSec?"#E8ECF1":"#fff")+';color:'+(allSec?"#1E293B":"#94A3B8")+'"'+(allSec?" data-fb-a":" data-fb")+'>ÂÖ®„Å¶</button>';for(var k=0;k<S.sections.length;k++){var sec=S.sections[k],actS=S.fSec===sec.id;h+='<button class="btn" onclick="window._fSec(\''+escA(sec.id)+'\')" style="padding:3px 10px;border-radius:14px;font-size:11px;border:'+(actS?"1.5px solid "+sec.color:"1.5px solid transparent")+';background:'+(actS?sec.color+"18":"#fff")+';color:'+(actS?sec.color:"#94A3B8")+'"'+(actS?"":" data-fb")+'>'+esc(sec.name)+'</button>';}h+='</div>';}h+='</div>';return h;}
function renderEmpty(){var none=S.tasks.length===0;return '<div style="text-align:center;padding:80px 20px;animation:fadeIn .4s ease"><div style="font-size:48px;margin-bottom:16px">üìù</div><p style="font-size:16px;font-weight:600;color:#64748B;margin-bottom:6px" data-txs">'+(none?"„Çø„Çπ„ÇØ„Åå„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì":"Ë©≤ÂΩì„Åô„Çã„Çø„Çπ„ÇØ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì")+'</p><p style="font-size:13px;color:#94A3B8" data-txm>'+(none?"„Äå+ „Çø„Çπ„ÇØËøΩÂä†„Äç„Åã„Çâ„Çø„Çπ„ÇØ„Çí‰ΩúÊàê„Åó„Åæ„Åó„Çá„ÅÜ":"„Éï„Ç£„É´„Çø„ÇíÂ§âÊõ¥„Åó„Å¶„Åø„Å¶„Åè„Å†„Åï„ÅÑ")+'</p></div>';}

// ‚îÄ‚îÄ‚îÄ ÈÄ±Êú´ÔºÜ‰ªäÊó•Á∑ö„ÅÆHTMLÁîüÊàêÔºàÂÖ±ÈÄöÂåñÔºâ ‚îÄ‚îÄ‚îÄ
function weekendBgs(total,start,cls){var r="";for(var i=0;i<total;i++){var dd=addD(start,i);if(dd.getDay()===0||dd.getDay()===6)r+='<div class="'+cls+'" style="position:absolute;left:'+(i*DW)+'px;top:0;width:'+DW+'px;height:100%"></div>';}return r;}
function todayLine(todayOff,total){if(todayOff>=0&&todayOff<total)return '<div style="position:absolute;left:'+(todayOff*DW+DW/2)+'px;top:0;width:2px;height:100%;background:#1E88E5;opacity:.25;z-index:1"></div>';return "";}

function renderTimeline(tasks){
  var r=calcTimelineRange(tasks);
  var start=r.start,end=r.end,total=r.total;
  var todayOff=dBtw(start,new Date());
  // Êúà„Éò„ÉÉ„ÉÄ„Éº
  var months=[],d=new Date(start),lastM=-1;while(d<=end){if(d.getMonth()!==lastM){lastM=d.getMonth();months.push({l:d.getFullYear()+"Âπ¥"+(d.getMonth()+1)+"Êúà",s:0});}months[months.length-1].s++;d=addD(d,1);}
  var mH="";for(var i=0;i<months.length;i++){var m=months[i];mH+='<div style="width:'+(m.s*DW)+'px;min-width:'+(m.s*DW)+'px;padding:10px 12px;font-size:12px;font-weight:700;color:#64748B;border-right:1px solid #F1F5F9" data-txs data-bdl">'+m.l+'</div>';}
  // Êó•„Éò„ÉÉ„ÉÄ„Éº
  var dH="";for(i=0;i<total;i++){var dd=addD(start,i),we=dd.getDay()===0||dd.getDay()===6,td=toDS(dd)===toDS(new Date());dH+='<div style="width:'+DW+'px;min-width:'+DW+'px;text-align:center;padding:6px 0;font-size:10px;font-weight:'+(td?800:500)+';color:'+(td?"#1E88E5":we?"#CBD5E1":"#94A3B8")+';background:'+(td?"#E3F2FD":"transparent")+';border-radius:'+(td?6:0)+'px">'+dd.getDate()+'</div>';}

  // ‚òÖ „Çª„ÇØ„Ç∑„Éß„É≥Âà•„Ç∞„É´„Éº„Éî„É≥„Ç∞
  var isAll=S.fA===null; // ÂÖ®Âì°Ë°®Á§∫„Åã
  var groups=[];
  for(var si=0;si<S.sections.length;si++){
    var sec=S.sections[si];
    var secTasks=tasks.filter(function(t){return t.section_id===sec.id;});
    // ‚òÖ ÂÖ®Âì°Ë°®Á§∫„ÅÆÂ†¥Âêà„ÅØ„Çø„Çπ„ÇØ0„Åß„ÇÇ„Çª„ÇØ„Ç∑„Éß„É≥Ë°®Á§∫
    if(secTasks.length>0||isAll) groups.push({section:sec,tasks:secTasks});
  }
  var noSec=tasks.filter(function(t){return !t.section_id;});
  if(noSec.length>0)groups.push({section:{id:null,name:"Êú™ÂàÜÈ°û",color:"#94A3B8"},tasks:noSec});
  // „Çø„Çπ„ÇØ„ÇÇ„Çª„ÇØ„Ç∑„Éß„É≥„ÇÇ„Å™„ÅÑ
  if(groups.length===0&&tasks.length===0){
    return renderEmpty();
  }

  var rH="";
  for(var gi=0;gi<groups.length;gi++){
    var g=groups[gi],sec2=g.section,gTasks=g.tasks;
    var secDone=gTasks.filter(function(t){return t.status==="done";}).length;
    var secProg=gTasks.length>0?Math.round(secDone/gTasks.length*100):0;
    var secIdSafe=sec2.id?escA(sec2.id):"";

    // „Çª„ÇØ„Ç∑„Éß„É≥„Éò„ÉÉ„ÉÄ„ÉºË°å
    rH+='<div class="sec-row" style="display:flex">';
    rH+='<div style="width:'+LEFT_W+'px;min-width:'+LEFT_W+'px;padding:10px 16px;border-right:1px solid #E8ECF1;display:flex;align-items:center;gap:10px">';
    rH+='<div style="width:4px;height:24px;border-radius:2px;background:'+sec2.color+'"></div>';
    rH+='<div style="flex:1;min-width:0"><div style="font-size:13px;font-weight:700;color:#1E293B;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" data-tx>'+esc(sec2.name)+'</div>';
    if(gTasks.length>0){
      rH+='<div style="display:flex;align-items:center;gap:8px;margin-top:3px"><div style="flex:1;max-width:80px;height:4px;background:#E8ECF1;border-radius:2px;overflow:hidden"><div style="height:100%;width:'+secProg+'%;background:'+sec2.color+';border-radius:2px"></div></div><span style="font-size:10px;color:#94A3B8;font-weight:600">'+secDone+'/'+gTasks.length+'</span></div>';
    } else {
      rH+='<div style="font-size:10px;color:#CBD5E1;margin-top:2px">„Çø„Çπ„ÇØ„Å™„Åó</div>';
    }
    rH+='</div></div>';
    // ‚òÖ „Çª„ÇØ„Ç∑„Éß„É≥„Éò„ÉÉ„ÉÄ„Éº„ÅÆÂè≥ÂÅ¥„Ç®„É™„Ç¢Ôºà„ÇØ„É™„ÉÉ„ÇØ„Åß„Çø„Çπ„ÇØËøΩÂä†Ôºâ
    rH+='<div class="gantt-area" style="flex:1;height:44px;position:relative" onclick="window._ganttClick(event,\''+secIdSafe+'\')">';
    rH+=weekendBgs(total,start,"we-a")+todayLine(todayOff,total);
    rH+='<div class="gantt-hint" style="left:50%">+ „ÇØ„É™„ÉÉ„ÇØ„Åß„Çø„Çπ„ÇØËøΩÂä†</div>';
    rH+='</div></div>';

    // „Çø„Çπ„ÇØ0„ÅÆ„Çª„ÇØ„Ç∑„Éß„É≥ÔºàÁ©∫Ë°å„Çí1„Å§Ë°®Á§∫Ôºâ
    if(gTasks.length===0){
      rH+='<div class="empty-sec-row" style="display:flex;cursor:pointer" onclick="window._ganttClick(event,\''+secIdSafe+'\')">';
      rH+='<div style="width:'+LEFT_W+'px;min-width:'+LEFT_W+'px;padding:10px 16px 10px 36px;border-right:1px solid #F1F5F9;display:flex;align-items:center" data-bdl">';
      rH+='<div class="add-task-hint"><span style="font-size:14px">+</span> „Çø„Çπ„ÇØ„ÇíËøΩÂä†...</div>';
      rH+='</div>';
      rH+='<div class="gantt-area" style="flex:1;height:40px;position:relative">';
      rH+=weekendBgs(total,start,"we-b")+todayLine(todayOff,total);
      rH+='</div></div>';
      continue;
    }

    // „Çø„Çπ„ÇØË°å
    var sorted=gTasks.slice().sort(function(a,b){return new Date(a.start_date)-new Date(b.start_date);});
    for(var ti2=0;ti2<sorted.length;ti2++){
      var t=sorted[ti2],c=mc(t.assignee),sOff=dBtw(start,t.start_date),dur=dBtw(t.start_date,t.due_date)+1,st=getSt(t.status),over=new Date(t.due_date)<new Date()&&t.status!=="done",barW=Math.max(dur*DW-4,20);

      // ‚òÖ „Éê„Éº„ÅÆ„É©„Éô„É´„ÅØ„Çø„Çπ„ÇØÂêç„Å´Â§âÊõ¥
      var barLabel=barW>60?'<span style="opacity:.95;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:'+(barW-20)+'px;display:inline-block">'+esc(t.title)+'</span>':"";

      rH+='<div class="tl-row" style="display:flex;border-bottom:1px solid #F1F5F9;cursor:pointer">';
      rH+='<div style="width:'+LEFT_W+'px;min-width:'+LEFT_W+'px;padding:8px 16px 8px 36px;border-right:1px solid #F1F5F9;display:flex;align-items:center;gap:8px" data-tleft data-bdl" onclick="window._editT(\''+escA(t.id)+'\')">';
      rH+='<span style="font-size:11px;color:'+st.c+'">'+st.i+'</span>';
      rH+='<div style="flex:1;min-width:0"><div style="font-size:12px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;text-decoration:'+(t.status==="done"?"line-through":"none")+';opacity:'+(t.status==="done"?.5:1)+'" data-tx>'+esc(t.title)+'</div>';
      rH+='<div style="display:flex;align-items:center;gap:4px;margin-top:2px"><span style="font-size:10px;font-weight:600;color:'+c.tx+';background:'+c.bg+';padding:0 7px;border-radius:8px;line-height:18px">'+esc(t.assignee)+'</span>';
      rH+='<span style="font-size:9px;color:#CBD5E1">'+fmtD(t.start_date)+'‚Äì'+fmtD(t.due_date)+'</span>';
      var urg=getUrgency(t);if(urg.level!=="ok"&&urg.level!=="done")rH+='<span style="font-size:8px;font-weight:700;color:'+urg.color+';background:'+urg.bg+';padding:0 5px;border-radius:6px;line-height:16px">'+urg.label+'</span>';
      rH+='</div></div></div>';
      // ‚òÖ „Ç¨„É≥„Éà„ÉÅ„É£„Éº„Éà„Ç®„É™„Ç¢Ôºà„ÇØ„É™„ÉÉ„ÇØ„Åß„Çø„Çπ„ÇØËøΩÂä† or „Éê„Éº„ÇØ„É™„ÉÉ„ÇØ„ÅßÁ∑®ÈõÜÔºâ
      rH+='<div class="gantt-area" style="flex:1;height:52px;position:relative" onclick="window._ganttClick(event,\''+secIdSafe+'\')">';
      rH+=weekendBgs(total,start,"we-b")+todayLine(todayOff,total);
      rH+='<div class="tl-bar" onclick="event.stopPropagation();window._editT(\''+escA(t.id)+'\')" style="position:absolute;left:'+(sOff*DW+2)+'px;top:12px;height:28px;width:'+barW+'px;background:'+(t.status==="done"?c.bar+"40":c.bar)+';border-radius:8px;display:flex;align-items:center;padding-left:10px;font-size:10px;font-weight:600;color:#fff;overflow:hidden;white-space:nowrap;z-index:2;box-shadow:0 2px 6px '+c.bar+'30;cursor:pointer">'+barLabel+'</div>';
      rH+='</div></div>';
    }
  }

  return '<div style="background:#fff;border-radius:16px;border:1px solid #E8ECF1;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,.04);animation:fadeIn .3s ease" data-card><div style="overflow-x:auto"><div style="min-width:'+(total*DW+LEFT_W)+'px"><div style="display:flex;border-bottom:1px solid #F1F5F9"><div style="width:'+LEFT_W+'px;min-width:'+LEFT_W+'px;border-right:1px solid #F1F5F9;padding:10px 16px;font-size:11px;font-weight:700;color:#94A3B8" data-bdl data-txm>„Çª„ÇØ„Ç∑„Éß„É≥ / „Çø„Çπ„ÇØ</div><div style="display:flex;flex:1">'+mH+'</div></div><div style="display:flex;border-bottom:1px solid #E8ECF1"><div style="width:'+LEFT_W+'px;min-width:'+LEFT_W+'px;border-right:1px solid #F1F5F9"></div><div style="display:flex">'+dH+'</div></div>'+rH+'</div></div></div>';
}

function renderList(tasks){
  var groups=[];for(var si=0;si<S.sections.length;si++){var sec=S.sections[si];var st=tasks.filter(function(t){return t.section_id===sec.id;});if(st.length>0)groups.push({section:sec,tasks:st});}
  var noSec=tasks.filter(function(t){return !t.section_id;});if(noSec.length>0)groups.push({section:{id:null,name:"Êú™ÂàÜÈ°û",color:"#94A3B8"},tasks:noSec});
  var h='<div style="display:flex;flex-direction:column;gap:16px;animation:fadeIn .3s ease">';
  for(var gi=0;gi<groups.length;gi++){
    var g=groups[gi],sec2=g.section;var secDone=g.tasks.filter(function(t){return t.status==="done";}).length;var secProg=g.tasks.length>0?Math.round(secDone/g.tasks.length*100):0;
    h+='<div><div data-sec-hd style="display:flex;align-items:center;gap:10px;margin-bottom:8px;padding:0 4px"><div style="width:4px;height:20px;border-radius:2px;background:'+sec2.color+'"></div><span style="font-size:14px;font-weight:700" data-tx>'+esc(sec2.name)+'</span><div style="display:flex;align-items:center;gap:6px"><div style="width:60px;height:4px;background:#E8ECF1;border-radius:2px;overflow:hidden"><div style="height:100%;width:'+secProg+'%;background:'+sec2.color+';border-radius:2px"></div></div><span style="font-size:10px;color:#94A3B8;font-weight:600">'+secDone+'/'+g.tasks.length+'</span></div></div><div style="display:flex;flex-direction:column;gap:6px">';
    var sorted=g.tasks.slice().sort(function(a,b){return new Date(a.due_date)-new Date(b.due_date);});
    for(var i=0;i<sorted.length;i++){var t=sorted[i],c=mc(t.assignee),sst=getSt(t.status),over=new Date(t.due_date)<new Date()&&t.status!=="done",urg=getUrgency(t);
      var urgTag=(urg.level!=="ok"&&urg.level!=="done")?'<span style="font-size:9px;font-weight:700;padding:2px 7px;border-radius:6px;background:'+urg.bg+';color:'+urg.color+';white-space:nowrap">'+urg.label+'</span>':"";
      h+='<div class="lc" data-card onclick="window._editT(\''+escA(t.id)+'\')" style="background:#fff;border-radius:12px;padding:14px 18px;border:1px solid '+(urg.level==="overdue"?"#FECACA":urg.level==="today"?"#FED7AA":"#E8ECF1")+';cursor:pointer;display:flex;align-items:center;gap:14px;transition:all .15s;box-shadow:0 1px 3px rgba(0,0,0,.03)"><div style="width:28px;height:28px;border-radius:8px;background:'+sst.c+'18;display:flex;align-items:center;justify-content:center;font-size:14px;color:'+sst.c+';flex-shrink:0">'+sst.i+'</div><div style="flex:1;min-width:0"><div style="font-size:13px;font-weight:600;text-decoration:'+(t.status==="done"?"line-through":"none")+';opacity:'+(t.status==="done"?.5:1)+';overflow:hidden;text-overflow:ellipsis;white-space:nowrap" data-tx>'+esc(t.title)+'</div></div><span style="font-size:10px;font-weight:600;color:'+c.tx+';background:'+c.bg+';padding:3px 10px;border-radius:16px;flex-shrink:0">'+esc(t.assignee)+'</span>'+urgTag+'<div style="text-align:right;flex-shrink:0"><div style="font-size:11px;font-weight:600;color:'+(over?"#DC2626":"#64748B")+'">'+fmtD(t.start_date)+' ‚Äì '+fmtD(t.due_date)+'</div></div></div>';}
    h+='</div></div>';}
  h+='</div>';return h;
}

function renderTaskModal(){
  var t=S.eTask,today=toDS(new Date()),week=toDS(addD(new Date(),7));
  var sd=t?t.start_date:(S.clickStartDate||today);
  var dd2=t?t.due_date:toDS(addD(new Date(sd),7));
  var secId=t?(t.section_id||""):(S.clickSecId||"");
  var title=t?t.title:"",assignee=t?t.assignee:(S.members.length>0?S.members[0].name:"");
  var status=t?t.status:"not_started",desc=t?(t.description||""):"";
  var mO="";for(var i=0;i<S.members.length;i++){var mm=S.members[i];mO+='<option value="'+escA(mm.name)+'"'+(mm.name===assignee?" selected":"")+'>'+esc(mm.name)+'</option>';}
  var sO="";for(var j=0;j<STS.length;j++){var s=STS[j];sO+='<option value="'+s.v+'"'+(s.v===status?" selected":"")+'>'+s.i+' '+s.l+'</option>';}
  var secO='<option value=""'+(secId===""?" selected":"")+'>ÔºàÊú™ÂàÜÈ°ûÔºâ</option>';for(var k=0;k<S.sections.length;k++){var sec=S.sections[k];secO+='<option value="'+escA(sec.id)+'"'+(sec.id===secId?" selected":"")+'>'+esc(sec.name)+'</option>';}
  // Á∑äÊÄ•Â∫¶„Éê„ÉÉ„Ç∏ÔºàÁ∑®ÈõÜÊôÇ„ÅÆ„ÅøÔºâ
  var urgBadge="";
  if(t){var urg=getUrgency(t);if(urg.level!=="ok"&&urg.level!=="done")urgBadge='<span style="font-size:11px;font-weight:700;padding:3px 10px;border-radius:8px;background:'+urg.bg+';color:'+urg.color+'">'+urg.label+'</span>';}
  // „Éú„Çø„É≥Ë°å
  var leftBtns="";
  if(t){leftBtns='<button class="btn" onclick="window._delT(\''+escA(t.id)+'\')" style="padding:8px 14px;border-radius:10px;background:#FEE2E2;color:#DC2626;font-size:12px">ÂâäÈô§</button><button class="btn" onclick="window._dupT(\''+escA(t.id)+'\')" style="padding:8px 14px;border-radius:10px;border:1.5px solid #E2E8F0;background:#fff;color:#64748B;font-size:12px" data-btn-n>üìã Ë§áË£Ω</button>';}
  // „Ç≥„É°„É≥„ÉàÊ¨ÑÔºàÁ∑®ÈõÜÊôÇ„ÅÆ„ÅøÔºâ
  var commentHtml="";
  if(t){
    var commentAuthorO="";for(var ci=0;ci<S.members.length;ci++){var cm2=S.members[ci];commentAuthorO+='<option value="'+escA(cm2.name)+'">'+esc(cm2.name)+'</option>';}
    commentHtml='<div style="border-top:1px solid #F1F5F9;margin-top:6px;padding-top:16px"><div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px"><label class="fl" style="margin:0">üí¨ „Ç≥„É°„É≥„Éà</label><span style="font-size:10px;color:#CBD5E1" data-txf>'+S.taskComments.length+'‰ª∂</span></div><div style="display:flex;gap:6px;margin-bottom:12px"><select class="fi" id="f-cm-author" style="width:100px;flex-shrink:0;font-size:12px;padding:8px 10px">'+commentAuthorO+'</select><input class="fi" id="f-cm-body" placeholder="„Ç≥„É°„É≥„Éà„ÇíÂÖ•Âäõ..." onkeydown="if(event.key===\'Enter\')window._postComment()" style="flex:1;font-size:12px;padding:8px 10px"><button class="btn" onclick="window._postComment()" style="padding:8px 14px;border-radius:10px;background:#1E293B;color:#fff;font-size:11px;white-space:nowrap;flex-shrink:0" data-btn-a>ÈÄÅ‰ø°</button></div><div id="comments-area" style="max-height:180px;overflow-y:auto">'+(S.commentsLoading?'<div style="text-align:center;padding:12px;font-size:12px;color:#94A3B8" data-txm>Ë™≠„ÅøËæº„Åø‰∏≠...</div>':(S.taskComments.length===0?'<div style="text-align:center;padding:16px;font-size:12px;color:#CBD5E1" data-txf>„Ç≥„É°„É≥„Éà„ÅØ„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì</div>':function(){var ch="";for(var ci2=0;ci2<S.taskComments.length;ci2++){var cm=S.taskComments[ci2];var d=new Date(cm.created_at);var ts2=(d.getMonth()+1)+"/"+d.getDate()+" "+d.getHours()+":"+String(d.getMinutes()).padStart(2,"0");ch+='<div style="padding:10px 0;'+(ci2<S.taskComments.length-1?"border-bottom:1px solid #F1F5F9":"")+'"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px"><span style="font-size:11px;font-weight:700;color:#1E293B" data-tx>'+esc(cm.author)+'</span><span style="font-size:10px;color:#CBD5E1" data-txf>'+ts2+'</span></div><div style="font-size:12px;color:#64748B;line-height:1.6;white-space:pre-wrap">'+esc(cm.body)+'</div></div>';}return ch;}()))+'</div></div>';
  }
  return '<div class="overlay" onclick="window._closeM()"><div class="mbox" onclick="event.stopPropagation()" style="width:min(560px,92vw)"><div class="mhdr"><div style="display:flex;align-items:center;gap:10px"><h2 class="mtitle">'+(t?"„Çø„Çπ„ÇØ„ÇíÁ∑®ÈõÜ":"Êñ∞„Åó„ÅÑ„Çø„Çπ„ÇØ")+'</h2>'+urgBadge+'</div><button class="mclose" onclick="window._closeM()">√ó</button></div><div class="fg"><label class="fl">„Çø„Çπ„ÇØÂêç *</label><input class="fi" id="f-title" value="'+escA(title)+'" placeholder="‰æãÔºö„Éá„Ç∂„Ç§„É≥„É¨„Éì„É•„Éº"></div><div class="fg"><label class="fl">„Çª„ÇØ„Ç∑„Éß„É≥</label><select class="fi" id="f-section">'+secO+'</select></div><div class="fr fg"><div><label class="fl">ÊãÖÂΩìËÄÖ</label><select class="fi" id="f-assignee">'+mO+'</select></div><div><label class="fl">„Çπ„ÉÜ„Éº„Çø„Çπ</label><select class="fi" id="f-status">'+sO+'</select></div></div><div class="fr fg"><div><label class="fl">ÈñãÂßãÊó•</label><input type="date" class="fi" id="f-start" value="'+sd+'"></div><div><label class="fl">ÊúüÊó•</label><input type="date" class="fi" id="f-due" value="'+dd2+'"></div></div><div class="fg"><label class="fl">„É°„É¢Ôºà‰ªªÊÑèÔºâ</label><textarea class="fi" id="f-desc" rows="2" placeholder="Ë£úË∂≥‰∫ãÈ†Ö„Åå„ÅÇ„Çå„Å∞...">'+esc(desc)+'</textarea></div>'+commentHtml+'<div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px"><div style="display:flex;gap:6px;margin-right:auto">'+leftBtns+'</div><button class="btn" onclick="window._closeM()" style="padding:10px 22px;border-radius:10px;border:1.5px solid #E2E8F0;background:#fff;color:#64748B;font-size:13px" data-btn-n>„Ç≠„É£„É≥„Çª„É´</button><button class="btn" id="btn-save" onclick="window._saveT()" style="padding:10px 28px;border-radius:10px;background:#1E293B;color:#fff;font-size:13px" data-btn-a>'+(t?"Êõ¥Êñ∞":"‰ΩúÊàê")+'</button></div></div></div>';
}
function renderMemberModal(){var ch="";for(var i=0;i<S.members.length;i++){var m=S.members[i],c=COLORS[i%COLORS.length];ch+='<div style="display:flex;align-items:center;gap:6px;background:'+c.bg+';padding:6px 10px 6px 14px;border-radius:20px;font-size:13px;font-weight:600;color:'+c.tx+'"><span>'+esc(m.name)+'</span><button class="btn" onclick="window._rmM(\''+escA(m.id)+'\')" style="width:20px;height:20px;border-radius:50%;background:rgba(0,0,0,.08);font-size:12px;display:flex;align-items:center;justify-content:center;color:'+c.tx+';padding:0">√ó</button></div>';}return '<div class="overlay" onclick="window._closeM()"><div class="mbox" onclick="event.stopPropagation()"><div class="mhdr"><h2 class="mtitle">„É°„É≥„Éê„ÉºÁÆ°ÁêÜ</h2><button class="mclose" onclick="window._closeM()">√ó</button></div><div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:20px">'+ch+'</div><div style="display:flex;gap:8px"><input class="fi" id="f-newmember" placeholder="Êñ∞„Åó„ÅÑ„É°„É≥„Éê„ÉºÂêç" onkeydown="if(event.key===\'Enter\')window._addM()" style="flex:1"><button class="btn" onclick="window._addM()" style="padding:10px 20px;border-radius:10px;background:#1E293B;color:#fff;font-size:13px;white-space:nowrap" data-btn-a>ËøΩÂä†</button></div></div></div>';}
function renderPasswordModal(){
  var errHtml=S.passError?'<div style="color:#DC2626;font-size:12px;font-weight:600;margin-top:8px;display:flex;align-items:center;gap:4px"><span>‚ö†Ô∏è</span> „Éë„Çπ„ÉØ„Éº„Éâ„ÅåÈÅï„ÅÑ„Åæ„Åô</div>':"";
  return '<div class="overlay" onclick="window._closeM()"><div class="mbox" onclick="event.stopPropagation()" style="width:min(380px,88vw);text-align:center"><div style="margin-bottom:20px"><div style="width:56px;height:56px;border-radius:16px;background:#F1F5F9;display:flex;align-items:center;justify-content:center;font-size:28px;margin:0 auto 14px" data-lock-bg>üîí</div><h2 style="font-size:18px;font-weight:700;margin-bottom:4px" data-tx>„É°„É≥„Éê„ÉºÁÆ°ÁêÜ</h2><p style="font-size:12px;color:#94A3B8" data-txm>„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p></div><div style="text-align:left"><input class="fi" id="f-pass" type="password" placeholder="„Éë„Çπ„ÉØ„Éº„Éâ" onkeydown="if(event.key===\'Enter\')window._checkPass()" style="text-align:center;font-size:18px;letter-spacing:8px">'+errHtml+'</div><div style="display:flex;gap:10px;margin-top:20px"><button class="btn" onclick="window._closeM()" style="flex:1;padding:10px;border-radius:10px;border:1.5px solid #E2E8F0;background:#fff;color:#64748B;font-size:13px" data-btn-n>„Ç≠„É£„É≥„Çª„É´</button><button class="btn" onclick="window._checkPass()" style="flex:1;padding:10px;border-radius:10px;background:#1E293B;color:#fff;font-size:13px" data-btn-a>„É≠„ÉÉ„ÇØËß£Èô§</button></div></div></div>';
}
function renderConfirmDeleteMember(){
  var m=S.confirmDelMember;if(!m)return"";
  var mName="";for(var i=0;i<S.members.length;i++){if(S.members[i].id===m){mName=S.members[i].name;break;}}
  var tCount=S.tasks.filter(function(t){return t.assignee===mName;}).length;
  return '<div class="overlay" style="z-index:1100" onclick="window._cancelRm()"><div class="mbox" onclick="event.stopPropagation()" style="width:min(400px,88vw);text-align:center"><div style="width:56px;height:56px;border-radius:16px;background:#FEE2E2;display:flex;align-items:center;justify-content:center;font-size:28px;margin:0 auto 16px" data-del-bg>‚ö†Ô∏è</div><h2 style="font-size:18px;font-weight:700;margin-bottom:8px" data-tx>„É°„É≥„Éê„Éº„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü</h2><p style="font-size:13px;color:#64748B;line-height:1.7" data-txs"><strong style="color:#1E293B">'+esc(mName)+'</strong> „ÇíÂâäÈô§„Åó„Åæ„Åô„ÄÇ'+(tCount>0?'<br>„Åì„ÅÆ„É°„É≥„Éê„Éº„Å´Á¥ê„Å•„Åè <strong style="color:#DC2626">'+tCount+' ‰ª∂„ÅÆ„Çø„Çπ„ÇØ</strong>„ÅÆÊãÖÂΩìËÄÖ„ÅåÁ©∫„Å´„Å™„Çä„Åæ„Åô„ÄÇ':'')+'</p><div style="display:flex;gap:10px;margin-top:20px"><button class="btn" onclick="window._cancelRm()" style="flex:1;padding:10px;border-radius:10px;border:1.5px solid #E2E8F0;background:#fff;color:#64748B;font-size:13px" data-btn-n>„Ç≠„É£„É≥„Çª„É´</button><button class="btn" onclick="window._confirmRm()" style="flex:1;padding:10px;border-radius:10px;background:#DC2626;color:#fff;font-size:13px">ÂâäÈô§„Åô„Çã</button></div></div></div>';
}
function renderSectionModal(){
  var items="";for(var i=0;i<S.sections.length;i++){var sec=S.sections[i];var tCount=S.tasks.filter(function(t){return t.section_id===sec.id;}).length;items+='<div style="display:flex;align-items:center;gap:10px;padding:10px 14px;background:#FAFBFC;border-radius:10px;border:1px solid #F1F5F9" data-card><div style="width:4px;height:28px;border-radius:2px;background:'+sec.color+';flex-shrink:0"></div><div style="flex:1;min-width:0"><div style="font-size:13px;font-weight:600" data-tx>'+esc(sec.name)+'</div><div style="font-size:10px;color:#94A3B8;margin-top:1px" data-txm>'+tCount+' „Çø„Çπ„ÇØ</div></div><button class="btn" onclick="window._rmSec(\''+escA(sec.id)+'\')" style="width:24px;height:24px;border-radius:6px;background:#FEE2E2;font-size:12px;display:flex;align-items:center;justify-content:center;color:#DC2626;padding:0;flex-shrink:0">√ó</button></div>';}
  var colorBtns="";for(var ci=0;ci<SEC_COLORS.length;ci++){colorBtns+='<button class="btn" onclick="document.getElementById(\'f-seccolor\').value=\''+SEC_COLORS[ci]+'\';this.parentNode.querySelectorAll(\'button\').forEach(function(b){b.style.outline=\'none\'});this.style.outline=\'3px solid #1E293B\'" style="width:28px;height:28px;border-radius:50%;background:'+SEC_COLORS[ci]+';padding:0'+(ci===0?';outline:3px solid #1E293B':'')+'"></button>';}
  return '<div class="overlay" onclick="window._closeM()"><div class="mbox" onclick="event.stopPropagation()"><div class="mhdr"><h2 class="mtitle">„Çª„ÇØ„Ç∑„Éß„É≥ÁÆ°ÁêÜ</h2><button class="mclose" onclick="window._closeM()">√ó</button></div><div style="display:flex;flex-direction:column;gap:8px;margin-bottom:20px;max-height:240px;overflow-y:auto">'+(items||'<p style="font-size:13px;color:#94A3B8;text-align:center;padding:16px" data-txm>„Çª„ÇØ„Ç∑„Éß„É≥„Åå„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì</p>')+'</div><div style="border-top:1px solid #F1F5F9;padding-top:16px"><p style="font-size:12px;font-weight:600;color:#64748B;margin-bottom:10px" data-txs>Êñ∞„Åó„ÅÑ„Çª„ÇØ„Ç∑„Éß„É≥„ÇíËøΩÂä†</p><div style="display:flex;gap:8px;margin-bottom:10px;align-items:center"><input class="fi" id="f-newsec" placeholder="„Çª„ÇØ„Ç∑„Éß„É≥Âêç" onkeydown="if(event.key===\'Enter\')window._addSec()" style="flex:1"><input type="hidden" id="f-seccolor" value="'+SEC_COLORS[0]+'"><button class="btn" onclick="window._addSec()" style="padding:10px 20px;border-radius:10px;background:#1E293B;color:#fff;font-size:13px;white-space:nowrap" data-btn-a>ËøΩÂä†</button></div><div style="display:flex;gap:6px;align-items:center"><span style="font-size:11px;color:#94A3B8;margin-right:4px" data-txm>Ëâ≤:</span>'+colorBtns+'</div></div></div></div>';
}

// ‚îÄ‚îÄ‚îÄ „Ç∞„É≠„Éº„Éê„É´„Ç§„Éô„É≥„Éà ‚îÄ‚îÄ‚îÄ
window._appLogin=function(){var inp=document.getElementById("f-apppass");var val=inp?inp.value:"";if(val===APP_PASS){S.appUnlocked=true;S.appPassError=false;try{sessionStorage.setItem("tb_auth","1");}catch(e){}if(SUPABASE_URL&&SUPABASE_ANON_KEY){S.loading=true;render();loadData(false);setInterval(function(){loadData(true);},5000);}else{render();}}else{S.appPassError=true;render();}};
window._toggleDark=function(){S.dark=!S.dark;document.body.classList.toggle("dark",S.dark);try{localStorage.setItem("tb_dark",S.dark?"1":"0");}catch(e){}render();};
window._openTask=function(){S.clickSecId=null;S.clickStartDate=null;S.eTask=null;S.modal="task";render();};
window._editT=function(id){S.clickSecId=null;S.clickStartDate=null;for(var i=0;i<S.tasks.length;i++){if(S.tasks[i].id===id){S.eTask=S.tasks[i];break;}}S.modal="task";S.taskComments=[];S.commentsLoading=true;render();loadComments(id);};
window._dupT=function(id){
  var orig=null;for(var i=0;i<S.tasks.length;i++){if(S.tasks[i].id===id){orig=S.tasks[i];break;}}if(!orig)return;
  var p={title:orig.title+" („Ç≥„Éî„Éº)",assignee:orig.assignee,start_date:orig.start_date,due_date:orig.due_date,status:"not_started",description:orig.description||"",section_id:orig.section_id||null};
  apiFetch("tasks",{method:"POST",body:JSON.stringify(p)}).then(function(){showToast("„Çø„Çπ„ÇØ„ÇíË§áË£Ω„Åó„Åæ„Åó„Åü");S.modal=null;S.eTask=null;return loadData(true);}).catch(function(e){showToast("Ë§áË£Ω„Å´Â§±Êïó„Åó„Åæ„Åó„Åü","err");console.error(e);});
};
window._postComment=function(){
  if(!S.eTask)return;
  var bodyEl=document.getElementById("f-cm-body");var authorEl=document.getElementById("f-cm-author");
  var body=bodyEl?bodyEl.value.trim():"";var author=authorEl?authorEl.value:"";
  if(!body||!author)return;
  apiFetch("comments",{method:"POST",body:JSON.stringify({task_id:S.eTask.id,author:author,body:body})}).then(function(){if(bodyEl)bodyEl.value="";loadComments(S.eTask.id);}).catch(function(e){showToast("„Ç≥„É°„É≥„Éà„ÅÆÊäïÁ®ø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü","err");console.error(e);});
};
window._openMember=function(){if(S.memberUnlocked){S.modal="member";render();}else{S.passError=false;S.modal="password";render();}};
window._checkPass=function(){var inp=document.getElementById("f-pass");var val=inp?inp.value:"";if(val===MEMBER_PASS){S.memberUnlocked=true;S.passError=false;S.modal="member";render();}else{S.passError=true;render();}};
window._cancelRm=function(){S.confirmDelMember=null;render();};
window._confirmRm=function(){var id=S.confirmDelMember;if(!id)return;S.confirmDelMember=null;apiFetch("members?id=eq."+id,{method:"DELETE"}).then(function(){showToast("„É°„É≥„Éê„Éº„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü");return loadData(true);}).then(function(){S.modal="member";render();}).catch(function(e){showToast("ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü","err");console.error(e);});};
window._openSec=function(){S.modal="section";render();};
window._closeM=function(){S.modal=null;S.eTask=null;S.clickSecId=null;S.clickStartDate=null;S.memberUnlocked=false;S.passError=false;S.confirmDelMember=null;render();};
window._setV=function(v){S.view=v;render();};
window._fA=function(v){S.fA=S.fA===v?null:v;render();};
window._fS=function(v){S.fS=S.fS===v?null:v;render();};
window._fSec=function(v){S.fSec=S.fSec===v?null:v;render();};
window._saveT=function(){var el=document.getElementById("f-title");var title=el?el.value.trim():"";if(!title)return;var secVal=document.getElementById("f-section").value;var p={title:title,assignee:document.getElementById("f-assignee").value,start_date:document.getElementById("f-start").value,due_date:document.getElementById("f-due").value,status:document.getElementById("f-status").value,description:document.getElementById("f-desc").value,section_id:secVal||null};var btn=document.getElementById("btn-save");if(btn){btn.textContent="‰øùÂ≠ò‰∏≠...";btn.disabled=true;}var pr=S.eTask?apiFetch("tasks?id=eq."+S.eTask.id,{method:"PATCH",body:JSON.stringify(Object.assign(p,{updated_at:new Date().toISOString()}))}):apiFetch("tasks",{method:"POST",body:JSON.stringify(p)});pr.then(function(){showToast(S.eTask?"„Çø„Çπ„ÇØ„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü":"„Çø„Çπ„ÇØ„Çí‰ΩúÊàê„Åó„Åæ„Åó„Åü");S.modal=null;S.eTask=null;S.clickSecId=null;S.clickStartDate=null;return loadData(true);}).catch(function(e){showToast("‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü","err");console.error(e);render();});};
window._delT=function(id){apiFetch("tasks?id=eq."+id,{method:"DELETE"}).then(function(){showToast("„Çø„Çπ„ÇØ„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü");S.modal=null;S.eTask=null;return loadData(true);}).catch(function(e){showToast("ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü","err");console.error(e);});};
window._addM=function(){var inp=document.getElementById("f-newmember");var name=inp?inp.value.trim():"";if(!name)return;for(var i=0;i<S.members.length;i++){if(S.members[i].name===name)return;}apiFetch("members",{method:"POST",body:JSON.stringify({name:name})}).then(function(){showToast(name+" „ÇíËøΩÂä†„Åó„Åæ„Åó„Åü");return loadData(true);}).then(function(){S.modal="member";render();}).catch(function(e){showToast("ËøΩÂä†„Å´Â§±Êïó„Åó„Åæ„Åó„Åü","err");console.error(e);});};
window._rmM=function(id){S.confirmDelMember=id;render();};
window._addSec=function(){var inp=document.getElementById("f-newsec");var name=inp?inp.value.trim():"";if(!name)return;var color=document.getElementById("f-seccolor").value||SEC_COLORS[0];var order=S.sections.length;apiFetch("sections",{method:"POST",body:JSON.stringify({name:name,color:color,sort_order:order})}).then(function(){showToast(name+" „ÇíËøΩÂä†„Åó„Åæ„Åó„Åü");return loadData(true);}).then(function(){S.modal="section";render();}).catch(function(e){showToast("ËøΩÂä†„Å´Â§±Êïó„Åó„Åæ„Åó„Åü","err");console.error(e);});};
window._rmSec=function(id){apiFetch("sections?id=eq."+id,{method:"DELETE"}).then(function(){showToast("„Çª„ÇØ„Ç∑„Éß„É≥„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü");return loadData(true);}).then(function(){S.modal="section";render();}).catch(function(e){showToast("ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü","err");console.error(e);});};
// ‚òÖ „Çø„ÉñÈÄöÁü•„Éê„ÉÉ„Ç∏
var ORIG_TITLE="TaskBoard";
function updateTabBadge(){if(S.newTaskCount>0){document.title="(üî¥"+S.newTaskCount+"‰ª∂) "+ORIG_TITLE;}else{document.title=ORIG_TITLE;}}
document.addEventListener("visibilitychange",function(){if(!document.hidden&&S.newTaskCount>0){S.newTaskCount=0;updateTabBadge();}});

// ‚òÖ „Çª„ÉÉ„Ç∑„Éß„É≥Ë™çË®ºÂæ©ÂÖÉ
try{if(sessionStorage.getItem("tb_auth")==="1")S.appUnlocked=true;}catch(e){}
try{if(localStorage.getItem("tb_dark")==="1"){S.dark=true;document.body.classList.add("dark");}}catch(e){}
if(SUPABASE_URL&&SUPABASE_ANON_KEY){if(S.appUnlocked){loadData(false);setInterval(function(){loadData(true);},5000);}else{S.loading=false;render();}}else{S.loading=false;render();}
})();
</script>
</body>
</html>
