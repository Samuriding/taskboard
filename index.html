<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TaskBoard - ãƒãƒ¼ãƒ ã‚¿ã‚¹ã‚¯ç®¡ç†</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“‹</text></svg>">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Noto Sans JP','Hiragino Sans',sans-serif;background:#F8FAFC;color:#1E293B;transition:background .25s,color .25s}
    ::-webkit-scrollbar{height:8px;width:8px}
    ::-webkit-scrollbar-track{background:#F1F5F9;border-radius:4px}
    ::-webkit-scrollbar-thumb{background:#CBD5E1;border-radius:4px}
    @keyframes modalIn{from{opacity:0;transform:translateY(12px) scale(.97)}to{opacity:1;transform:none}}
    @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
    @keyframes spin{to{transform:rotate(360deg)}}
    @keyframes toastIn{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:none}}
    .btn{border:none;cursor:pointer;font-family:'Noto Sans JP',sans-serif;font-weight:600;transition:all .15s}
    .btn:hover{filter:brightness(.95)}.btn:active{transform:scale(.97)}
    input,select,textarea{font-family:'Noto Sans JP',sans-serif}
    .overlay{position:fixed;inset:0;z-index:1000;display:flex;align-items:center;justify-content:center;background:rgba(15,23,42,.45);backdrop-filter:blur(4px)}
    .mbox{background:#fff;border-radius:16px;padding:32px 36px;width:min(520px,92vw);box-shadow:0 25px 60px rgba(0,0,0,.18);animation:modalIn .25s ease;max-height:90vh;overflow-y:auto}
    .mhdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px}
    .mtitle{font-size:20px;font-weight:700}
    .mclose{width:32px;height:32px;border-radius:8px;border:none;background:#F1F5F9;cursor:pointer;font-size:18px;color:#64748B;display:flex;align-items:center;justify-content:center}
    .fi{width:100%;padding:10px 14px;border-radius:10px;border:1.5px solid #E2E8F0;font-size:14px;outline:none;background:#FAFBFC}
    .fi:focus{border-color:#94A3B8}
    .fl{font-size:12px;font-weight:600;color:#64748B;margin-bottom:6px;display:block}
    .fg{margin-bottom:18px}
    .fr{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .toast{position:fixed;bottom:24px;right:24px;z-index:2000;padding:12px 20px;border-radius:12px;font-size:13px;font-weight:600;box-shadow:0 8px 24px rgba(0,0,0,.2);color:#fff;animation:toastIn .3s ease}
    .tl-row:hover{background:#FAFBFE !important}
    .tl-bar{transition:transform .15s,box-shadow .15s}.tl-bar:hover{transform:scaleY(1.15)}
    .lc:hover{box-shadow:0 2px 12px rgba(0,0,0,.06) !important}
    .sec-row{background:#F8FAFC;border-bottom:1px solid #E8ECF1}
    .err-box{max-width:560px;margin:40px auto;background:#FEE2E2;border:1px solid #FECACA;border-radius:12px;padding:20px;font-size:13px;color:#991B1B;white-space:pre-wrap;word-break:break-all}
    .gantt-area{cursor:crosshair;position:relative}
    .gantt-area:hover .gantt-hint{opacity:1}
    .gantt-hint{position:absolute;top:50%;transform:translateY(-50%);pointer-events:none;opacity:0;transition:opacity .2s;background:#1E293B;color:#fff;font-size:10px;font-weight:600;padding:3px 10px;border-radius:6px;white-space:nowrap;z-index:5}
    .empty-sec-row{border-bottom:1px solid #F1F5F9}
    .empty-sec-row:hover{background:#F8FAFC}
    .add-task-hint{opacity:0;transition:opacity .15s;font-size:11px;color:#94A3B8;display:flex;align-items:center;gap:4px}
    .empty-sec-row:hover .add-task-hint{opacity:1}
    /* â˜… ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆåœŸæ—¥ã‚«ãƒ©ãƒ ç”¨ã‚¯ãƒ©ã‚¹ */
    .we-a{background:#F1F5F9}.we-b{background:#FAFBFC}
    /* â˜… ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ãƒˆã‚°ãƒ« */
    .dm-sw{width:44px;height:24px;border-radius:12px;border:none;cursor:pointer;position:relative;background:#CBD5E1;padding:0;flex-shrink:0;transition:background .3s}
    .dm-sw .dm-k{width:18px;height:18px;border-radius:50%;background:#fff;position:absolute;top:3px;left:3px;transition:transform .3s;box-shadow:0 1px 3px rgba(0,0,0,.2)}
    .dm-sw .dm-i{position:absolute;top:50%;transform:translateY(-50%);font-size:12px;transition:opacity .3s}
    .dm-sun{left:5px;opacity:1}.dm-moon{right:5px;opacity:0}
    body.dark .dm-sw{background:#475569}
    body.dark .dm-sw .dm-k{transform:translateX(20px)}
    body.dark .dm-sun{opacity:0}body.dark .dm-moon{opacity:1}
    /* â˜…â˜…â˜… ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ â˜…â˜…â˜… */
    body.dark{background:#0F172A;color:#E2E8F0}
    body.dark ::-webkit-scrollbar-track{background:#1E293B}
    body.dark ::-webkit-scrollbar-thumb{background:#475569}
    body.dark .overlay{background:rgba(0,0,0,.6)}
    body.dark .mbox{background:#1E293B !important;color:#E2E8F0;box-shadow:0 25px 60px rgba(0,0,0,.5)}
    body.dark .mtitle{color:#E2E8F0}
    body.dark .mclose{background:#334155;color:#94A3B8}
    body.dark .fi{background:#0F172A !important;border-color:#334155 !important;color:#E2E8F0 !important}
    body.dark .fi:focus{border-color:#64748B !important}
    body.dark .fl{color:#94A3B8}
    body.dark .sec-row{background:#172033 !important;border-color:#334155 !important;color:#E2E8F0 !important}
    body.dark .sec-row *{color:#E2E8F0 !important}
    body.dark .sec-row span[style*="color:#94A3B8"]{color:#64748B !important}
    body.dark .sec-row div[style*="background:#E8ECF1"]{background:#334155 !important}
    body.dark .tl-row:hover{background:#253045 !important}
    body.dark .lc:hover{box-shadow:0 2px 12px rgba(0,0,0,.3) !important}
    body.dark .gantt-hint{background:#E2E8F0;color:#0F172A}
    body.dark .empty-sec-row{border-color:#253045 !important}
    body.dark .empty-sec-row:hover{background:#172033 !important}
    body.dark .add-task-hint{color:#64748B}
    body.dark .we-a{background:#182338 !important}.we-b{background:#FAFBFC}
    body.dark .we-b{background:#162035 !important}
    body.dark .err-box{background:#451A1A;border-color:#7F1D1D;color:#FCA5A5}
    /* ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ»ã‚«ãƒ¼ãƒ‰ãƒ»ãƒ‘ãƒãƒ«ï¼ˆinline styleä¸Šæ›¸ãï¼‰ */
    body.dark [data-hd]{background:#1E293B !important;border-color:#334155 !important}
    body.dark [data-hd] h1{color:#E2E8F0 !important}
    body.dark [data-hd] span[style*="font-weight:600"]{color:#E2E8F0 !important}
    body.dark [data-card]{background:#1E293B !important;border-color:#334155 !important}
    body.dark [data-tl]{background:#1E293B !important;border-color:#334155 !important}
    body.dark [data-al]{background:#422006 !important;border-color:#854D0E !important}
    body.dark [data-al] span{color:#FDE68A !important}
    /* ãƒœãƒ¼ãƒ€ãƒ¼ç³» */
    body.dark [data-bd]{border-color:#334155 !important}
    body.dark [data-bdl]{border-color:#253045 !important}
    /* ãƒœã‚¿ãƒ³ç³» */
    body.dark [data-btn-n]{background:#1E293B !important;border-color:#334155 !important;color:#94A3B8 !important}
    body.dark [data-btn-a]{background:#E2E8F0 !important;color:#0F172A !important}
    body.dark [data-vt] [data-vt-a]{background:#0F172A !important}
    body.dark [data-vt]{background:#334155 !important}
    /* ãƒ†ã‚­ã‚¹ãƒˆç³» */
    body.dark [data-tx]{color:#E2E8F0 !important}
    body.dark [data-txs]{color:#94A3B8 !important}
    body.dark [data-txm]{color:#64748B !important}
    body.dark [data-txf]{color:#475569 !important}
    /* ãƒªã‚¹ãƒˆãƒ“ãƒ¥ãƒ¼ ã‚»ã‚¯ã‚·ãƒ§ãƒ³é€²æ—ãƒãƒ¼èƒŒæ™¯ */
    body.dark div[style*="background:#E8ECF1"]{background:#334155 !important}
    /* ãƒªã‚¹ãƒˆãƒ“ãƒ¥ãƒ¼ ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãƒ˜ãƒƒãƒ€ãƒ¼ */
    body.dark [data-sec-hd] span{color:#E2E8F0 !important}
    body.dark [data-sec-hd] span[style*="color:#94A3B8"]{color:#64748B !important}
    /* ãƒªã‚¹ãƒˆãƒ“ãƒ¥ãƒ¼ æ—¥ä»˜ãƒ†ã‚­ã‚¹ãƒˆ */
    body.dark div[style*="color:#64748B"]{color:#94A3B8 !important}
    /* ã‚¿ã‚¹ã‚¯è¡Œã®å·¦ãƒ‘ãƒãƒ«å…¨ãƒ†ã‚­ã‚¹ãƒˆ */
    body.dark .tl-row div[style*="color:#1E293B"]{color:#E2E8F0 !important}
    body.dark .tl-row span[style*="color:#B0B8C4"]{color:#64748B !important}
    /* ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆè¡Œ */
    body.dark .tl-row{border-color:#1E293B !important}
    body.dark [data-tleft]{border-color:#334155 !important}
    body.dark [data-ga]{border-color:#253045 !important}
    /* ãƒ•ã‚£ãƒ«ã‚¿ãƒœã‚¿ãƒ³éæ´»æ€§ */
    body.dark [data-fb]{background:#1E293B !important;color:#64748B !important}
    body.dark [data-fb-a]{color:#E2E8F0 !important}
    /* ãƒ­ãƒƒã‚¯ãƒ¢ãƒ¼ãƒ€ãƒ« */
    body.dark [data-lock-bg]{background:#334155 !important}
    body.dark [data-del-bg]{background:#7F1D1D !important}
  </style>
</head>
<body>
<div id="app"><div style="display:flex;align-items:center;justify-content:center;min-height:100vh;color:#94A3B8;font-size:14px">èª­ã¿è¾¼ã¿ä¸­...</div></div>
<script>
var SUPABASE_URL="https://gztmshxdtcjwsxkckhlt.supabase.co";
var SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd6dG1zaHhkdGNqd3N4a2NraGx0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2NTU1MzIsImV4cCI6MjA4NjIzMTUzMn0.a_cnZJyN9SbtA9ThVwZHKFqf9GGVQi8XzvclcKAntKM";
var MEMBER_PASS="0926";
window.onerror=function(msg,src,line){var el=document.getElementById("app");if(el)el.innerHTML='<div class="err-box"><strong>ã‚¨ãƒ©ãƒ¼</strong><br>'+msg+'<br>è¡Œ:'+line+'</div>';};
(function(){
var COLORS=[{bg:"#E8F5E9",bar:"#43A047",tx:"#2E7D32"},{bg:"#E3F2FD",bar:"#1E88E5",tx:"#1565C0"},{bg:"#FFF3E0",bar:"#FB8C00",tx:"#E65100"},{bg:"#F3E5F5",bar:"#8E24AA",tx:"#6A1B9A"},{bg:"#E0F7FA",bar:"#00ACC1",tx:"#00838F"},{bg:"#FBE9E7",bar:"#F4511E",tx:"#BF360C"},{bg:"#F1F8E9",bar:"#7CB342",tx:"#558B2F"},{bg:"#EDE7F6",bar:"#5E35B1",tx:"#4527A0"}];
var SEC_COLORS=["#1E88E5","#43A047","#FB8C00","#8E24AA","#00ACC1","#F4511E","#5E35B1","#D81B60"];
var STS=[{v:"not_started",l:"æœªç€æ‰‹",c:"#9E9E9E",i:"â—‹"},{v:"in_progress",l:"é€²è¡Œä¸­",c:"#1E88E5",i:"â—"},{v:"done",l:"å®Œäº†",c:"#43A047",i:"â—"}];
var DW=36,LEFT_W=240;
var S={tasks:[],members:[],sections:[],loading:true,syncing:false,lastSync:null,view:"timeline",fA:null,fS:null,fSec:null,modal:null,eTask:null,toast:null,tTimer:null,prevJSON:"",
  // ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆä¸Šã‚¯ãƒªãƒƒã‚¯ç”¨ã®ä¸€æ™‚ãƒ‡ãƒ¼ã‚¿
  clickSecId:null,clickStartDate:null,
  memberUnlocked:false,passError:false,confirmDelMember:null,
  taskComments:[],commentsLoading:false,dark:false
};
function fmtD(d){var x=new Date(d);return(x.getMonth()+1)+"/"+x.getDate();}
function toDS(d){var x=new Date(d);return x.getFullYear()+"-"+String(x.getMonth()+1).padStart(2,"0")+"-"+String(x.getDate()).padStart(2,"0");}
function dBtw(a,b){return Math.round((new Date(b)-new Date(a))/86400000);}
function addD(d,n){var x=new Date(d);x.setDate(x.getDate()+n);return x;}
function mc(name){var i=0;for(var j=0;j<S.members.length;j++){if(S.members[j].name===name){i=j;break;}}return COLORS[i%COLORS.length];}
function esc(s){if(!s)return"";var d=document.createElement("div");d.textContent=s;return d.innerHTML;}
function escA(s){return esc(s).replace(/'/g,"&#39;").replace(/"/g,"&quot;");}
function getSt(v){for(var i=0;i<STS.length;i++){if(STS[i].v===v)return STS[i];}return STS[0];}
// â˜… æœŸé™ã‚¢ãƒ©ãƒ¼ãƒˆï¼šæ®‹ã‚Šæ—¥æ•°ã‹ã‚‰ç·Šæ€¥åº¦ã‚’åˆ¤å®š
function getUrgency(t){
  if(t.status==="done")return{level:"done",label:"",color:""};
  var days=dBtw(toDS(new Date()),t.due_date);
  if(days<0)return{level:"overdue",label:"æœŸé™è¶…é "+Math.abs(days)+"æ—¥",color:"#DC2626",bg:"#FEE2E2"};
  if(days===0)return{level:"today",label:"æœ¬æ—¥æœŸé™",color:"#EA580C",bg:"#FFF7ED"};
  if(days<=2)return{level:"soon",label:"ã‚ã¨"+days+"æ—¥",color:"#D97706",bg:"#FFFBEB"};
  if(days<=5)return{level:"near",label:"ã‚ã¨"+days+"æ—¥",color:"#CA8A04",bg:"#FEFCE8"};
  return{level:"ok",label:"",color:""};
}
function loadComments(taskId){
  S.commentsLoading=true;S.taskComments=[];
  apiFetch("comments?task_id=eq."+taskId+"&order=created_at.desc").then(function(r){return r.json();}).then(function(data){S.taskComments=data;S.commentsLoading=false;renderCommentsArea();}).catch(function(e){console.error(e);S.commentsLoading=false;renderCommentsArea();});
}
function renderCommentsArea(){
  var el=document.getElementById("comments-area");if(!el)return;
  if(S.commentsLoading){el.innerHTML='<div style="text-align:center;padding:12px;font-size:12px;color:#94A3B8" data-txm>èª­ã¿è¾¼ã¿ä¸­...</div>';return;}
  var h="";
  if(S.taskComments.length===0){h='<div style="text-align:center;padding:16px;font-size:12px;color:#CBD5E1" data-txf>ã‚³ãƒ¡ãƒ³ãƒˆã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>';}
  else{for(var i=0;i<S.taskComments.length;i++){var cm=S.taskComments[i];var d=new Date(cm.created_at);var ts=(d.getMonth()+1)+"/"+d.getDate()+" "+d.getHours()+":"+String(d.getMinutes()).padStart(2,"0");h+='<div style="padding:10px 0;border-bottom:1px solid #F1F5F9"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px"><span style="font-size:11px;font-weight:700;color:#1E293B" data-tx>'+esc(cm.author)+'</span><span style="font-size:10px;color:#CBD5E1" data-txf>'+ts+'</span></div><div style="font-size:12px;color:#64748B;line-height:1.6;white-space:pre-wrap">'+esc(cm.body)+'</div></div>';}}
  el.innerHTML=h;
}
function showToast(msg,type){if(S.tTimer)clearTimeout(S.tTimer);S.toast={m:msg,t:type||"ok"};renderToast();S.tTimer=setTimeout(function(){S.toast=null;renderToast();},3000);}
function renderToast(){var el=document.getElementById("toast-container");if(!el){el=document.createElement("div");el.id="toast-container";document.body.appendChild(el);}el.innerHTML=S.toast?'<div class="toast" style="background:'+(S.toast.t==="err"?"#DC2626":"#1E293B")+'">'+esc(S.toast.m)+'</div>':"";}
function updateSync(){var el=document.getElementById("sync-indicator");if(!el)return;var dot=S.syncing?"background:#1E88E5;animation:pulse 1s infinite":"background:#43A047";var txt=S.syncing?"åŒæœŸä¸­...":(S.lastSync?"æœ€çµ‚åŒæœŸ "+S.lastSync:"æ¥ç¶šæ¸ˆã¿");el.innerHTML='<div style="width:7px;height:7px;border-radius:50%;'+dot+'"></div>'+txt;el.style.color=S.syncing?"#1E88E5":"#94A3B8";}
function hdrs(){return{"apikey":SUPABASE_ANON_KEY,"Authorization":"Bearer "+SUPABASE_ANON_KEY,"Content-Type":"application/json","Prefer":"return=representation"};}
function apiFetch(path,opts){return fetch(SUPABASE_URL+"/rest/v1/"+path,Object.assign({headers:hdrs()},opts||{})).then(function(r){if(!r.ok)throw new Error("API "+r.status);return r;});}
function loadData(silent){
  if(!silent)S.syncing=true;if(silent)updateSync();
  return Promise.all([apiFetch("tasks?order=start_date.asc").then(function(r){return r.json();}),apiFetch("members?order=created_at.asc").then(function(r){return r.json();}),apiFetch("sections?order=sort_order.asc,created_at.asc").then(function(r){return r.json();})]).then(function(res){
    var nj=JSON.stringify(res);S.lastSync=new Date().toLocaleTimeString("ja-JP",{hour:"2-digit",minute:"2-digit"});var changed=nj!==S.prevJSON;S.tasks=res[0];S.members=res[1];S.sections=res[2];S.prevJSON=nj;
    if(silent&&!changed){S.syncing=false;updateSync();return;}
    if(silent&&S.modal){S.syncing=false;updateSync();return;}
    S.syncing=false;S.loading=false;render();
  }).catch(function(e){if(!silent)showToast("ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ","err");console.error(e);S.syncing=false;S.loading=false;if(!silent)render();updateSync();});
}

// â”€â”€â”€ ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³æ—¥ä»˜ç¯„å›²ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ã§ä½¿ã†ï¼‰ â”€â”€â”€
var TL={start:null,total:0};

function calcTimelineRange(tasks){
  var allDt=[];
  // ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Œã°ãã®ç¯„å›²ã‚’ä½¿ã†
  for(var i=0;i<tasks.length;i++){allDt.push(new Date(tasks[i].start_date).getTime());allDt.push(new Date(tasks[i].due_date).getTime());}
  // ã‚¿ã‚¹ã‚¯ãŒãªã„å ´åˆã¯ä»Šæ—¥ã‚’ä¸­å¿ƒã«å‰å¾Œ2é€±é–“
  if(allDt.length===0){
    var now=new Date();
    allDt.push(addD(now,-14).getTime());
    allDt.push(addD(now,14).getTime());
  }
  var minD=new Date(Math.min.apply(null,allDt)),maxD=new Date(Math.max.apply(null,allDt));
  TL.start=addD(minD,-3);
  var end=addD(maxD,3);
  TL.total=dBtw(TL.start,end)+1;
  return {start:TL.start,end:end,total:TL.total};
}

// â˜… ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸæ™‚ï¼šã‚¯ãƒªãƒƒã‚¯ä½ç½®ã‹ã‚‰æ—¥ä»˜ã‚’ç®—å‡ºã—ã¦ã‚¿ã‚¹ã‚¯è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
window._ganttClick=function(e,secId){
  // ãƒãƒ¼ä¸Šã®ã‚¯ãƒªãƒƒã‚¯ã¯ç„¡è¦–ï¼ˆã‚¿ã‚¹ã‚¯ç·¨é›†ãŒå„ªå…ˆï¼‰
  if(e.target.closest&&e.target.closest('.tl-bar'))return;
  var area=e.currentTarget;
  var rect=area.getBoundingClientRect();
  var x=e.clientX-rect.left;
  var dayIndex=Math.floor(x/DW);
  if(dayIndex<0)dayIndex=0;
  if(dayIndex>=TL.total)dayIndex=TL.total-1;
  var clickDate=addD(TL.start,dayIndex);
  S.clickSecId=secId||null;
  S.clickStartDate=toDS(clickDate);
  S.eTask=null;
  S.modal="task";
  render();
};

function render(){
  var app=document.getElementById("app");if(!app)return;
  try{
    if(!SUPABASE_URL||!SUPABASE_ANON_KEY){app.innerHTML=renderSetup();return;}
    if(S.loading){app.innerHTML='<div style="min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px"><div style="width:40px;height:40px;border:3px solid #E8ECF1;border-top-color:#1E293B;border-radius:50%;animation:spin .8s linear infinite" data-bd></div><p style="color:#64748B;font-size:14px;font-weight:600" data-txs>ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p></div>';return;}
    var filtered=S.tasks.filter(function(t){if(S.fA&&t.assignee!==S.fA)return false;if(S.fS&&t.status!==S.fS)return false;if(S.fSec&&S.fSec!=="__none__"&&t.section_id!==S.fSec)return false;return true;});
    var cnt={not_started:0,in_progress:0,done:0};S.tasks.forEach(function(t){cnt[t.status]++;});
    var h=renderHeader(cnt)+renderAlertBanner()+renderToolbar()+renderFilters()+'<div style="padding:0 28px 40px">';
    if(S.view==="timeline")h+=renderTimeline(filtered);
    else{if(filtered.length===0)h+=renderEmpty();else h+=renderList(filtered);}
    h+='</div>';
    if(S.modal==="task")h+=renderTaskModal();if(S.modal==="member")h+=renderMemberModal();if(S.modal==="section")h+=renderSectionModal();if(S.modal==="password")h+=renderPasswordModal();if(S.confirmDelMember)h+=renderConfirmDeleteMember();
    app.innerHTML=h;
    var ti=document.getElementById("f-title");if(ti)setTimeout(function(){ti.focus();},50);
    var ni=document.getElementById("f-newmember");if(ni&&S.modal==="member")setTimeout(function(){ni.focus();},50);
    var pi=document.getElementById("f-pass");if(pi&&S.modal==="password")setTimeout(function(){pi.focus();},50);
    var si2=document.getElementById("f-newsec");if(si2&&S.modal==="section")setTimeout(function(){si2.focus();},50);
  }catch(e){console.error(e);app.innerHTML='<div class="err-box"><strong>æç”»ã‚¨ãƒ©ãƒ¼</strong><br>'+esc(e.message)+'</div>';}
}
function renderSetup(){return '<div style="min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#F8FAFC,#E2E8F0)"><div style="background:#fff;border-radius:20px;padding:48px 44px;max-width:560px;width:92vw;box-shadow:0 20px 60px rgba(0,0,0,.08)"><div style="display:flex;align-items:center;gap:14px;margin-bottom:28px"><div style="width:48px;height:48px;border-radius:14px;background:#1E293B;display:flex;align-items:center;justify-content:center;font-size:24px">ğŸ“‹</div><div><h1 style="font-size:22px;font-weight:800">TaskBoard</h1><p style="font-size:12px;color:#94A3B8">åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—</p></div></div><div style="background:#FFFBEB;border:1px solid #FDE68A;border-radius:12px;padding:16px 20px;margin-bottom:24px"><p style="font-size:13px;color:#92400E;font-weight:600">âš ï¸ Supabaseã®è¨­å®šãŒå¿…è¦ã§ã™</p><p style="margin-top:8px;font-size:12px;color:#A16207;line-height:1.7">SUPABASE_URL ã¨ SUPABASE_ANON_KEY ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚</p></div></div></div>';}
function renderAlertBanner(){
  var urgent=[];
  for(var i=0;i<S.tasks.length;i++){var t=S.tasks[i],u=getUrgency(t);if(u.level==="overdue"||u.level==="today"||u.level==="soon")urgent.push({task:t,urg:u});}
  if(urgent.length===0)return"";
  urgent.sort(function(a,b){return dBtw(toDS(new Date()),a.task.due_date)-dBtw(toDS(new Date()),b.task.due_date);});
  var items="";var max=Math.min(urgent.length,5);
  for(var j=0;j<max;j++){var it=urgent[j];items+='<span onclick="window._editT(\''+escA(it.task.id)+'\')" style="display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:8px;font-size:11px;font-weight:600;background:'+it.urg.bg+';color:'+it.urg.color+';cursor:pointer;white-space:nowrap"><span style="font-size:9px">'+( it.urg.level==="overdue"?"ğŸ”´":it.urg.level==="today"?"ğŸŸ ":"ğŸŸ¡")+'</span>'+esc(it.task.title)+' <span style="opacity:.7">'+it.urg.label+'</span></span>';}
  if(urgent.length>5)items+='<span style="font-size:11px;color:#94A3B8;font-weight:500">ä»– '+(urgent.length-5)+'ä»¶</span>';
  return '<div style="padding:8px 28px;background:#FFFBEB;border-bottom:1px solid #FDE68A;display:flex;align-items:center;gap:8px;flex-wrap:wrap" data-al><span style="font-size:11px;font-weight:700;color:#92400E;display:flex;align-items:center;gap:4px;margin-right:4px;white-space:nowrap">ğŸ”” æœŸé™ã‚¢ãƒ©ãƒ¼ãƒˆ</span>'+items+'</div>';
}
function renderHeader(cnt){var syncDot=S.syncing?"background:#1E88E5;animation:pulse 1s infinite":"background:#43A047";var syncTxt=S.syncing?"åŒæœŸä¸­...":(S.lastSync?"æœ€çµ‚åŒæœŸ "+S.lastSync:"æ¥ç¶šæ¸ˆã¿");var syncCol=S.syncing?"#1E88E5":"#94A3B8";var stH="";for(var i=0;i<STS.length;i++){var s=STS[i];stH+='<div style="display:flex;align-items:center;gap:4px;font-size:12px;color:#64748B"><span style="color:'+s.c+';font-size:14px">'+s.i+'</span><span style="font-weight:600">'+cnt[s.v]+'</span></div>';}return '<div style="background:#fff;border-bottom:1px solid #E8ECF1;padding:14px 28px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100" data-hd="1"><div style="display:flex;align-items:center;gap:14px"><div style="width:36px;height:36px;border-radius:10px;background:#1E293B;display:flex;align-items:center;justify-content:center;font-size:18px">ğŸ“‹</div><div><h1 style="font-size:18px;font-weight:800;letter-spacing:-.02em;color:#1E293B">TaskBoard</h1><div id="sync-indicator" style="display:flex;align-items:center;gap:6px;font-size:11px;color:'+syncCol+';font-weight:500"><div style="width:7px;height:7px;border-radius:50%;'+syncDot+'"></div>'+syncTxt+'</div></div></div><div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap"><div style="display:flex;gap:12px;margin-right:8px">'+stH+'</div><button class="dm-sw" onclick="window._toggleDark()" title="ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰"><div class="dm-k"></div><span class="dm-i dm-sun">â˜€ï¸</span><span class="dm-i dm-moon">ğŸŒ™</span></button><button class="btn" onclick="window._openSec()" style="padding:8px 14px;border-radius:10px;border:1.5px solid #E2E8F0;background:#fff;font-size:13px;color:#64748B;display:flex;align-items:center;gap:5px" data-btn-n><span style="font-size:14px">ğŸ“</span> ã‚»ã‚¯ã‚·ãƒ§ãƒ³</button><button class="btn" onclick="window._openMember()" style="padding:8px 14px;border-radius:10px;border:1.5px solid #E2E8F0;background:#fff;font-size:13px;color:#64748B;display:flex;align-items:center;gap:5px" data-btn-n><span style="font-size:14px">ğŸ‘¥</span> ğŸ”’ãƒ¡ãƒ³ãƒãƒ¼</button><button class="btn" onclick="window._openTask()" style="padding:8px 20px;border-radius:10px;background:#1E293B;color:#fff;font-size:13px;display:flex;align-items:center;gap:6px;box-shadow:0 2px 8px rgba(30,41,59,.2)" data-btn-a><span style="font-size:16px">+</span> ã‚¿ã‚¹ã‚¯è¿½åŠ </button></div></div>';}
function renderToolbar(){var allA=S.fA===null;var h='<div style="padding:14px 28px 6px;display:flex;align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap"><div style="display:flex;gap:6px;flex-wrap:wrap"><button class="btn" onclick="window._fA(null)" style="padding:5px 14px;border-radius:20px;font-size:12px;border:'+(allA?"2px solid #1E293B":"1.5px solid #E2E8F0")+';background:'+(allA?"#1E293B":"#fff")+';color:'+(allA?"#fff":"#64748B")+'"'+(allA?" data-btn-a":" data-fb")+'>å…¨å“¡</button>';for(var i=0;i<S.members.length;i++){var m=S.members[i],c=COLORS[i%COLORS.length],a=S.fA===m.name;h+='<button class="btn" onclick="window._fA(\''+escA(m.name)+'\')" style="padding:5px 14px;border-radius:20px;font-size:12px;border:'+(a?"2px solid "+c.bar:"1.5px solid #E2E8F0")+';background:'+(a?c.bg:"#fff")+';color:'+(a?c.tx:"#64748B")+'"'+(a?"":" data-fb")+'>'+esc(m.name)+'</button>';}h+='</div><div style="display:flex;gap:4px;background:#E8ECF1;border-radius:10px;padding:3px" data-vt="1">';var vs=[["timeline","ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³"],["list","ãƒªã‚¹ãƒˆ"]];for(var j=0;j<vs.length;j++){var v=vs[j],act=S.view===v[0];h+='<button class="btn" onclick="window._setV(\''+v[0]+'\')" style="padding:6px 16px;border-radius:8px;background:'+(act?"#fff":"transparent")+';box-shadow:'+(act?"0 1px 4px rgba(0,0,0,.08)":"none")+';font-size:12px;color:#1E293B"'+(act?" data-vt-a":"")+' data-tx>'+v[1]+'</button>';}h+='</div></div>';return h;}
function renderFilters(){var h='<div style="padding:4px 28px 12px;display:flex;gap:16px;flex-wrap:wrap;align-items:center"><div style="display:flex;gap:5px;align-items:center"><span style="font-size:10px;font-weight:700;color:#94A3B8;margin-right:2px" data-txm>çŠ¶æ…‹:</span>';var allSt=[{v:null,l:"å…¨ã¦",c:"#1E293B",i:""}];for(var i=0;i<STS.length;i++)allSt.push({v:STS[i].v,l:STS[i].l,c:STS[i].c,i:STS[i].i});for(var j=0;j<allSt.length;j++){var s=allSt[j],act=S.fS===s.v,col=s.c;var oc=s.v?"window._fS('"+s.v+"')":"window._fS(null)";h+='<button class="btn" onclick="'+oc+'" style="padding:3px 10px;border-radius:14px;font-size:11px;border:'+(act?"1.5px solid "+col:"1.5px solid transparent")+';background:'+(act?(s.v?col+"18":"#E8ECF1"):"#fff")+';color:'+(act?col:"#94A3B8")+'"'+(act?"":" data-fb")+'>'+(s.i?s.i+" ":"")+s.l+'</button>';}h+='</div>';if(S.sections.length>0){h+='<div style="display:flex;gap:5px;align-items:center"><span style="font-size:10px;font-weight:700;color:#94A3B8;margin-right:2px" data-txm>ã‚»ã‚¯ã‚·ãƒ§ãƒ³:</span>';var allSec=S.fSec===null;h+='<button class="btn" onclick="window._fSec(null)" style="padding:3px 10px;border-radius:14px;font-size:11px;border:'+(allSec?"1.5px solid #1E293B":"1.5px solid transparent")+';background:'+(allSec?"#E8ECF1":"#fff")+';color:'+(allSec?"#1E293B":"#94A3B8")+'"'+(allSec?" data-fb-a":" data-fb")+'>å…¨ã¦</button>';for(var k=0;k<S.sections.length;k++){var sec=S.sections[k],actS=S.fSec===sec.id;h+='<button class="btn" onclick="window._fSec(\''+escA(sec.id)+'\')" style="padding:3px 10px;border-radius:14px;font-size:11px;border:'+(actS?"1.5px solid "+sec.color:"1.5px solid transparent")+';background:'+(actS?sec.color+"18":"#fff")+';color:'+(actS?sec.color:"#94A3B8")+'"'+(actS?"":" data-fb")+'>'+esc(sec.name)+'</button>';}h+='</div>';}h+='</div>';return h;}
function renderEmpty(){var none=S.tasks.length===0;return '<div style="text-align:center;padding:80px 20px;animation:fadeIn .4s ease"><div style="font-size:48px;margin-bottom:16px">ğŸ“</div><p style="font-size:16px;font-weight:600;color:#64748B;margin-bottom:6px" data-txs">'+(none?"ã‚¿ã‚¹ã‚¯ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“":"è©²å½“ã™ã‚‹ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“")+'</p><p style="font-size:13px;color:#94A3B8" data-txm>'+(none?"ã€Œ+ ã‚¿ã‚¹ã‚¯è¿½åŠ ã€ã‹ã‚‰ã‚¿ã‚¹ã‚¯ã‚’ä½œæˆã—ã¾ã—ã‚‡ã†":"ãƒ•ã‚£ãƒ«ã‚¿ã‚’å¤‰æ›´ã—ã¦ã¿ã¦ãã ã•ã„")+'</p></div>';}

// â”€â”€â”€ é€±æœ«ï¼†ä»Šæ—¥ç·šã®HTMLç”Ÿæˆï¼ˆå…±é€šåŒ–ï¼‰ â”€â”€â”€
function weekendBgs(total,start,cls){var r="";for(var i=0;i<total;i++){var dd=addD(start,i);if(dd.getDay()===0||dd.getDay()===6)r+='<div class="'+cls+'" style="position:absolute;left:'+(i*DW)+'px;top:0;width:'+DW+'px;height:100%"></div>';}return r;}
function todayLine(todayOff,total){if(todayOff>=0&&todayOff<total)return '<div style="position:absolute;left:'+(todayOff*DW+DW/2)+'px;top:0;width:2px;height:100%;background:#1E88E5;opacity:.25;z-index:1"></div>';return "";}

function renderTimeline(tasks){
  var r=calcTimelineRange(tasks);
  var start=r.start,end=r.end,total=r.total;
  var todayOff=dBtw(start,new Date());
  // æœˆãƒ˜ãƒƒãƒ€ãƒ¼
  var months=[],d=new Date(start),lastM=-1;while(d<=end){if(d.getMonth()!==lastM){lastM=d.getMonth();months.push({l:d.getFullYear()+"å¹´"+(d.getMonth()+1)+"æœˆ",s:0});}months[months.length-1].s++;d=addD(d,1);}
  var mH="";for(var i=0;i<months.length;i++){var m=months[i];mH+='<div style="width:'+(m.s*DW)+'px;min-width:'+(m.s*DW)+'px;padding:10px 12px;font-size:12px;font-weight:700;color:#64748B;border-right:1px solid #F1F5F9" data-txs data-bdl">'+m.l+'</div>';}
  // æ—¥ãƒ˜ãƒƒãƒ€ãƒ¼
  var dH="";for(i=0;i<total;i++){var dd=addD(start,i),we=dd.getDay()===0||dd.getDay()===6,td=toDS(dd)===toDS(new Date());dH+='<div style="width:'+DW+'px;min-width:'+DW+'px;text-align:center;padding:6px 0;font-size:10px;font-weight:'+(td?800:500)+';color:'+(td?"#1E88E5":we?"#CBD5E1":"#94A3B8")+';background:'+(td?"#E3F2FD":"transparent")+';border-radius:'+(td?6:0)+'px">'+dd.getDate()+'</div>';}

  // â˜… ã‚»ã‚¯ã‚·ãƒ§ãƒ³åˆ¥ã‚°ãƒ«ãƒ¼ãƒ”ãƒ³ã‚°
  var isAll=S.fA===null; // å…¨å“¡è¡¨ç¤ºã‹
  var groups=[];
  for(var si=0;si<S.sections.length;si++){
    var sec=S.sections[si];
    var secTasks=tasks.filter(function(t){return t.section_id===sec.id;});
    // â˜… å…¨å“¡è¡¨ç¤ºã®å ´åˆã¯ã‚¿ã‚¹ã‚¯0ã§ã‚‚ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤º
    if(secTasks.length>0||isAll) groups.push({section:sec,tasks:secTasks});
  }
  var noSec=tasks.filter(function(t){return !t.section_id;});
  if(noSec.length>0)groups.push({section:{id:null,name:"æœªåˆ†é¡",color:"#94A3B8"},tasks:noSec});
  // ã‚¿ã‚¹ã‚¯ã‚‚ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚‚ãªã„
  if(groups.length===0&&tasks.length===0){
    return renderEmpty();
  }

  var rH="";
  for(var gi=0;gi<groups.length;gi++){
    var g=groups[gi],sec2=g.section,gTasks=g.tasks;
    var secDone=gTasks.filter(function(t){return t.status==="done";}).length;
    var secProg=gTasks.length>0?Math.round(secDone/gTasks.length*100):0;
    var secIdSafe=sec2.id?escA(sec2.id):"";

    // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
    rH+='<div class="sec-row" style="display:flex">';
    rH+='<div style="width:'+LEFT_W+'px;min-width:'+LEFT_W+'px;padding:10px 16px;border-right:1px solid #E8ECF1;display:flex;align-items:center;gap:10px">';
    rH+='<div style="width:4px;height:24px;border-radius:2px;background:'+sec2.color+'"></div>';
    rH+='<div style="flex:1;min-width:0"><div style="font-size:13px;font-weight:700;color:#1E293B;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" data-tx>'+esc(sec2.name)+'</div>';
    if(gTasks.length>0){
      rH+='<div style="display:flex;align-items:center;gap:8px;margin-top:3px"><div style="flex:1;max-width:80px;height:4px;background:#E8ECF1;border-radius:2px;overflow:hidden"><div style="height:100%;width:'+secProg+'%;background:'+sec2.color+';border-radius:2px"></div></div><span style="font-size:10px;color:#94A3B8;font-weight:600">'+secDone+'/'+gTasks.length+'</span></div>';
    } else {
      rH+='<div style="font-size:10px;color:#CBD5E1;margin-top:2px">ã‚¿ã‚¹ã‚¯ãªã—</div>';
    }
    rH+='</div></div>';
    // â˜… ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãƒ˜ãƒƒãƒ€ãƒ¼ã®å³å´ã‚¨ãƒªã‚¢ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§ã‚¿ã‚¹ã‚¯è¿½åŠ ï¼‰
    rH+='<div class="gantt-area" style="flex:1;height:44px;position:relative" onclick="window._ganttClick(event,\''+secIdSafe+'\')">';
    rH+=weekendBgs(total,start,"we-a")+todayLine(todayOff,total);
    rH+='<div class="gantt-hint" style="left:50%">+ ã‚¯ãƒªãƒƒã‚¯ã§ã‚¿ã‚¹ã‚¯è¿½åŠ </div>';
    rH+='</div></div>';

    // ã‚¿ã‚¹ã‚¯0ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆç©ºè¡Œã‚’1ã¤è¡¨ç¤ºï¼‰
    if(gTasks.length===0){
      rH+='<div class="empty-sec-row" style="display:flex;cursor:pointer" onclick="window._ganttClick(event,\''+secIdSafe+'\')">';
      rH+='<div style="width:'+LEFT_W+'px;min-width:'+LEFT_W+'px;padding:10px 16px 10px 36px;border-right:1px solid #F1F5F9;display:flex;align-items:center" data-bdl">';
      rH+='<div class="add-task-hint"><span style="font-size:14px">+</span> ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ ...</div>';
      rH+='</div>';
      rH+='<div class="gantt-area" style="flex:1;height:40px;position:relative">';
      rH+=weekendBgs(total,start,"we-b")+todayLine(todayOff,total);
      rH+='</div></div>';
      continue;
    }

    // ã‚¿ã‚¹ã‚¯è¡Œ
    var sorted=gTasks.slice().sort(function(a,b){return new Date(a.start_date)-new Date(b.start_date);});
    for(var ti2=0;ti2<sorted.length;ti2++){
      var t=sorted[ti2],c=mc(t.assignee),sOff=dBtw(start,t.start_date),dur=dBtw(t.start_date,t.due_date)+1,st=getSt(t.status),over=new Date(t.due_date)<new Date()&&t.status!=="done",barW=Math.max(dur*DW-4,20);

      // â˜… ãƒãƒ¼ã®ãƒ©ãƒ™ãƒ«ã¯ã‚¿ã‚¹ã‚¯åã«å¤‰æ›´
      var barLabel=barW>60?'<span style="opacity:.95;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:'+(barW-20)+'px;display:inline-block">'+esc(t.title)+'</span>':"";

      rH+='<div class="tl-row" style="display:flex;border-bottom:1px solid #F1F5F9;cursor:pointer">';
      rH+='<div style="width:'+LEFT_W+'px;min-width:'+LEFT_W+'px;padding:8px 16px 8px 36px;border-right:1px solid #F1F5F9;display:flex;align-items:center;gap:8px" data-tleft data-bdl" onclick="window._editT(\''+escA(t.id)+'\')">';
      rH+='<span style="font-size:11px;color:'+st.c+'">'+st.i+'</span>';
      rH+='<div style="flex:1;min-width:0"><div style="font-size:12px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;text-decoration:'+(t.status==="done"?"line-through":"none")+';opacity:'+(t.status==="done"?.5:1)+'" data-tx>'+esc(t.title)+'</div>';
      rH+='<div style="display:flex;align-items:center;gap:4px;margin-top:2px"><span style="font-size:10px;font-weight:600;color:'+c.tx+';background:'+c.bg+';padding:0 7px;border-radius:8px;line-height:18px">'+esc(t.assignee)+'</span>';
      rH+='<span style="font-size:9px;color:#CBD5E1">'+fmtD(t.start_date)+'â€“'+fmtD(t.due_date)+'</span>';
      var urg=getUrgency(t);if(urg.level!=="ok"&&urg.level!=="done")rH+='<span style="font-size:8px;font-weight:700;color:'+urg.color+';background:'+urg.bg+';padding:0 5px;border-radius:6px;line-height:16px">'+urg.label+'</span>';
      rH+='</div></div></div>';
      // â˜… ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆã‚¨ãƒªã‚¢ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§ã‚¿ã‚¹ã‚¯è¿½åŠ  or ãƒãƒ¼ã‚¯ãƒªãƒƒã‚¯ã§ç·¨é›†ï¼‰
      rH+='<div class="gantt-area" style="flex:1;height:52px;position:relative" onclick="window._ganttClick(event,\''+secIdSafe+'\')">';
      rH+=weekendBgs(total,start,"we-b")+todayLine(todayOff,total);
      rH+='<div class="tl-bar" onclick="event.stopPropagation();window._editT(\''+escA(t.id)+'\')" style="position:absolute;left:'+(sOff*DW+2)+'px;top:12px;height:28px;width:'+barW+'px;background:'+(t.status==="done"?c.bar+"40":c.bar)+';border-radius:8px;display:flex;align-items:center;padding-left:10px;font-size:10px;font-weight:600;color:#fff;overflow:hidden;white-space:nowrap;z-index:2;box-shadow:0 2px 6px '+c.bar+'30;cursor:pointer">'+barLabel+'</div>';
      rH+='</div></div>';
    }
  }

  return '<div style="background:#fff;border-radius:16px;border:1px solid #E8ECF1;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,.04);animation:fadeIn .3s ease" data-card><div style="overflow-x:auto"><div style="min-width:'+(total*DW+LEFT_W)+'px"><div style="display:flex;border-bottom:1px solid #F1F5F9"><div style="width:'+LEFT_W+'px;min-width:'+LEFT_W+'px;border-right:1px solid #F1F5F9;padding:10px 16px;font-size:11px;font-weight:700;color:#94A3B8" data-bdl data-txm>ã‚»ã‚¯ã‚·ãƒ§ãƒ³ / ã‚¿ã‚¹ã‚¯</div><div style="display:flex;flex:1">'+mH+'</div></div><div style="display:flex;border-bottom:1px solid #E8ECF1"><div style="width:'+LEFT_W+'px;min-width:'+LEFT_W+'px;border-right:1px solid #F1F5F9"></div><div style="display:flex">'+dH+'</div></div>'+rH+'</div></div></div>';
}

function renderList(tasks){
  var groups=[];for(var si=0;si<S.sections.length;si++){var sec=S.sections[si];var st=tasks.filter(function(t){return t.section_id===sec.id;});if(st.length>0)groups.push({section:sec,tasks:st});}
  var noSec=tasks.filter(function(t){return !t.section_id;});if(noSec.length>0)groups.push({section:{id:null,name:"æœªåˆ†é¡",color:"#94A3B8"},tasks:noSec});
  var h='<div style="display:flex;flex-direction:column;gap:16px;animation:fadeIn .3s ease">';
  for(var gi=0;gi<groups.length;gi++){
    var g=groups[gi],sec2=g.section;var secDone=g.tasks.filter(function(t){return t.status==="done";}).length;var secProg=g.tasks.length>0?Math.round(secDone/g.tasks.length*100):0;
    h+='<div><div data-sec-hd style="display:flex;align-items:center;gap:10px;margin-bottom:8px;padding:0 4px"><div style="width:4px;height:20px;border-radius:2px;background:'+sec2.color+'"></div><span style="font-size:14px;font-weight:700" data-tx>'+esc(sec2.name)+'</span><div style="display:flex;align-items:center;gap:6px"><div style="width:60px;height:4px;background:#E8ECF1;border-radius:2px;overflow:hidden"><div style="height:100%;width:'+secProg+'%;background:'+sec2.color+';border-radius:2px"></div></div><span style="font-size:10px;color:#94A3B8;font-weight:600">'+secDone+'/'+g.tasks.length+'</span></div></div><div style="display:flex;flex-direction:column;gap:6px">';
    var sorted=g.tasks.slice().sort(function(a,b){return new Date(a.due_date)-new Date(b.due_date);});
    for(var i=0;i<sorted.length;i++){var t=sorted[i],c=mc(t.assignee),sst=getSt(t.status),over=new Date(t.due_date)<new Date()&&t.status!=="done",urg=getUrgency(t);
      var urgTag=(urg.level!=="ok"&&urg.level!=="done")?'<span style="font-size:9px;font-weight:700;padding:2px 7px;border-radius:6px;background:'+urg.bg+';color:'+urg.color+';white-space:nowrap">'+urg.label+'</span>':"";
      h+='<div class="lc" data-card onclick="window._editT(\''+escA(t.id)+'\')" style="background:#fff;border-radius:12px;padding:14px 18px;border:1px solid '+(urg.level==="overdue"?"#FECACA":urg.level==="today"?"#FED7AA":"#E8ECF1")+';cursor:pointer;display:flex;align-items:center;gap:14px;transition:all .15s;box-shadow:0 1px 3px rgba(0,0,0,.03)"><div style="width:28px;height:28px;border-radius:8px;background:'+sst.c+'18;display:flex;align-items:center;justify-content:center;font-size:14px;color:'+sst.c+';flex-shrink:0">'+sst.i+'</div><div style="flex:1;min-width:0"><div style="font-size:13px;font-weight:600;text-decoration:'+(t.status==="done"?"line-through":"none")+';opacity:'+(t.status==="done"?.5:1)+';overflow:hidden;text-overflow:ellipsis;white-space:nowrap" data-tx>'+esc(t.title)+'</div></div><span style="font-size:10px;font-weight:600;color:'+c.tx+';background:'+c.bg+';padding:3px 10px;border-radius:16px;flex-shrink:0">'+esc(t.assignee)+'</span>'+urgTag+'<div style="text-align:right;flex-shrink:0"><div style="font-size:11px;font-weight:600;color:'+(over?"#DC2626":"#64748B")+'">'+fmtD(t.start_date)+' â€“ '+fmtD(t.due_date)+'</div></div></div>';}
    h+='</div></div>';}
  h+='</div>';return h;
}

function renderTaskModal(){
  var t=S.eTask,today=toDS(new Date()),week=toDS(addD(new Date(),7));
  var sd=t?t.start_date:(S.clickStartDate||today);
  var dd2=t?t.due_date:toDS(addD(new Date(sd),7));
  var secId=t?(t.section_id||""):(S.clickSecId||"");
  var title=t?t.title:"",assignee=t?t.assignee:(S.members.length>0?S.members[0].name:"");
  var status=t?t.status:"not_started",desc=t?(t.description||""):"";
  var mO="";for(var i=0;i<S.members.length;i++){var mm=S.members[i];mO+='<option value="'+escA(mm.name)+'"'+(mm.name===assignee?" selected":"")+'>'+esc(mm.name)+'</option>';}
  var sO="";for(var j=0;j<STS.length;j++){var s=STS[j];sO+='<option value="'+s.v+'"'+(s.v===status?" selected":"")+'>'+s.i+' '+s.l+'</option>';}
  var secO='<option value=""'+(secId===""?" selected":"")+'>ï¼ˆæœªåˆ†é¡ï¼‰</option>';for(var k=0;k<S.sections.length;k++){var sec=S.sections[k];secO+='<option value="'+escA(sec.id)+'"'+(sec.id===secId?" selected":"")+'>'+esc(sec.name)+'</option>';}
  // ç·Šæ€¥åº¦ãƒãƒƒã‚¸ï¼ˆç·¨é›†æ™‚ã®ã¿ï¼‰
  var urgBadge="";
  if(t){var urg=getUrgency(t);if(urg.level!=="ok"&&urg.level!=="done")urgBadge='<span style="font-size:11px;font-weight:700;padding:3px 10px;border-radius:8px;background:'+urg.bg+';color:'+urg.color+'">'+urg.label+'</span>';}
  // ãƒœã‚¿ãƒ³è¡Œ
  var leftBtns="";
  if(t){leftBtns='<button class="btn" onclick="window._delT(\''+escA(t.id)+'\')" style="padding:8px 14px;border-radius:10px;background:#FEE2E2;color:#DC2626;font-size:12px">å‰Šé™¤</button><button class="btn" onclick="window._dupT(\''+escA(t.id)+'\')" style="padding:8px 14px;border-radius:10px;border:1.5px solid #E2E8F0;background:#fff;color:#64748B;font-size:12px" data-btn-n>ğŸ“‹ è¤‡è£½</button>';}
  // ã‚³ãƒ¡ãƒ³ãƒˆæ¬„ï¼ˆç·¨é›†æ™‚ã®ã¿ï¼‰
  var commentHtml="";
  if(t){
    var commentAuthorO="";for(var ci=0;ci<S.members.length;ci++){var cm2=S.members[ci];commentAuthorO+='<option value="'+escA(cm2.name)+'">'+esc(cm2.name)+'</option>';}
    commentHtml='<div style="border-top:1px solid #F1F5F9;margin-top:6px;padding-top:16px"><div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px"><label class="fl" style="margin:0">ğŸ’¬ ã‚³ãƒ¡ãƒ³ãƒˆ</label><span style="font-size:10px;color:#CBD5E1" data-txf>'+S.taskComments.length+'ä»¶</span></div><div style="display:flex;gap:6px;margin-bottom:12px"><select class="fi" id="f-cm-author" style="width:100px;flex-shrink:0;font-size:12px;padding:8px 10px">'+commentAuthorO+'</select><input class="fi" id="f-cm-body" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›..." onkeydown="if(event.key===\'Enter\')window._postComment()" style="flex:1;font-size:12px;padding:8px 10px"><button class="btn" onclick="window._postComment()" style="padding:8px 14px;border-radius:10px;background:#1E293B;color:#fff;font-size:11px;white-space:nowrap;flex-shrink:0" data-btn-a>é€ä¿¡</button></div><div id="comments-area" style="max-height:180px;overflow-y:auto">'+(S.commentsLoading?'<div style="text-align:center;padding:12px;font-size:12px;color:#94A3B8" data-txm>èª­ã¿è¾¼ã¿ä¸­...</div>':(S.taskComments.length===0?'<div style="text-align:center;padding:16px;font-size:12px;color:#CBD5E1" data-txf>ã‚³ãƒ¡ãƒ³ãƒˆã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>':function(){var ch="";for(var ci2=0;ci2<S.taskComments.length;ci2++){var cm=S.taskComments[ci2];var d=new Date(cm.created_at);var ts2=(d.getMonth()+1)+"/"+d.getDate()+" "+d.getHours()+":"+String(d.getMinutes()).padStart(2,"0");ch+='<div style="padding:10px 0;'+(ci2<S.taskComments.length-1?"border-bottom:1px solid #F1F5F9":"")+'"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px"><span style="font-size:11px;font-weight:700;color:#1E293B" data-tx>'+esc(cm.author)+'</span><span style="font-size:10px;color:#CBD5E1" data-txf>'+ts2+'</span></div><div style="font-size:12px;color:#64748B;line-height:1.6;white-space:pre-wrap">'+esc(cm.body)+'</div></div>';}return ch;}()))+'</div></div>';
  }
  return '<div class="overlay" onclick="window._closeM()"><div class="mbox" onclick="event.stopPropagation()" style="width:min(560px,92vw)"><div class="mhdr"><div style="display:flex;align-items:center;gap:10px"><h2 class="mtitle">'+(t?"ã‚¿ã‚¹ã‚¯ã‚’ç·¨é›†":"æ–°ã—ã„ã‚¿ã‚¹ã‚¯")+'</h2>'+urgBadge+'</div><button class="mclose" onclick="window._closeM()">Ã—</button></div><div class="fg"><label class="fl">ã‚¿ã‚¹ã‚¯å *</label><input class="fi" id="f-title" value="'+escA(title)+'" placeholder="ä¾‹ï¼šãƒ‡ã‚¶ã‚¤ãƒ³ãƒ¬ãƒ“ãƒ¥ãƒ¼"></div><div class="fg"><label class="fl">ã‚»ã‚¯ã‚·ãƒ§ãƒ³</label><select class="fi" id="f-section">'+secO+'</select></div><div class="fr fg"><div><label class="fl">æ‹…å½“è€…</label><select class="fi" id="f-assignee">'+mO+'</select></div><div><label class="fl">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label><select class="fi" id="f-status">'+sO+'</select></div></div><div class="fr fg"><div><label class="fl">é–‹å§‹æ—¥</label><input type="date" class="fi" id="f-start" value="'+sd+'"></div><div><label class="fl">æœŸæ—¥</label><input type="date" class="fi" id="f-due" value="'+dd2+'"></div></div><div class="fg"><label class="fl">ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label><textarea class="fi" id="f-desc" rows="2" placeholder="è£œè¶³äº‹é …ãŒã‚ã‚Œã°...">'+esc(desc)+'</textarea></div>'+commentHtml+'<div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px"><div style="display:flex;gap:6px;margin-right:auto">'+leftBtns+'</div><button class="btn" onclick="window._closeM()" style="padding:10px 22px;border-radius:10px;border:1.5px solid #E2E8F0;background:#fff;color:#64748B;font-size:13px" data-btn-n>ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button class="btn" id="btn-save" onclick="window._saveT()" style="padding:10px 28px;border-radius:10px;background:#1E293B;color:#fff;font-size:13px" data-btn-a>'+(t?"æ›´æ–°":"ä½œæˆ")+'</button></div></div></div>';
}
function renderMemberModal(){var ch="";for(var i=0;i<S.members.length;i++){var m=S.members[i],c=COLORS[i%COLORS.length];ch+='<div style="display:flex;align-items:center;gap:6px;background:'+c.bg+';padding:6px 10px 6px 14px;border-radius:20px;font-size:13px;font-weight:600;color:'+c.tx+'"><span>'+esc(m.name)+'</span><button class="btn" onclick="window._rmM(\''+escA(m.id)+'\')" style="width:20px;height:20px;border-radius:50%;background:rgba(0,0,0,.08);font-size:12px;display:flex;align-items:center;justify-content:center;color:'+c.tx+';padding:0">Ã—</button></div>';}return '<div class="overlay" onclick="window._closeM()"><div class="mbox" onclick="event.stopPropagation()"><div class="mhdr"><h2 class="mtitle">ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†</h2><button class="mclose" onclick="window._closeM()">Ã—</button></div><div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:20px">'+ch+'</div><div style="display:flex;gap:8px"><input class="fi" id="f-newmember" placeholder="æ–°ã—ã„ãƒ¡ãƒ³ãƒãƒ¼å" onkeydown="if(event.key===\'Enter\')window._addM()" style="flex:1"><button class="btn" onclick="window._addM()" style="padding:10px 20px;border-radius:10px;background:#1E293B;color:#fff;font-size:13px;white-space:nowrap" data-btn-a>è¿½åŠ </button></div></div></div>';}
function renderPasswordModal(){
  var errHtml=S.passError?'<div style="color:#DC2626;font-size:12px;font-weight:600;margin-top:8px;display:flex;align-items:center;gap:4px"><span>âš ï¸</span> ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™</div>':"";
  return '<div class="overlay" onclick="window._closeM()"><div class="mbox" onclick="event.stopPropagation()" style="width:min(380px,88vw);text-align:center"><div style="margin-bottom:20px"><div style="width:56px;height:56px;border-radius:16px;background:#F1F5F9;display:flex;align-items:center;justify-content:center;font-size:28px;margin:0 auto 14px" data-lock-bg>ğŸ”’</div><h2 style="font-size:18px;font-weight:700;margin-bottom:4px" data-tx>ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†</h2><p style="font-size:12px;color:#94A3B8" data-txm>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p></div><div style="text-align:left"><input class="fi" id="f-pass" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" onkeydown="if(event.key===\'Enter\')window._checkPass()" style="text-align:center;font-size:18px;letter-spacing:8px">'+errHtml+'</div><div style="display:flex;gap:10px;margin-top:20px"><button class="btn" onclick="window._closeM()" style="flex:1;padding:10px;border-radius:10px;border:1.5px solid #E2E8F0;background:#fff;color:#64748B;font-size:13px" data-btn-n>ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button class="btn" onclick="window._checkPass()" style="flex:1;padding:10px;border-radius:10px;background:#1E293B;color:#fff;font-size:13px" data-btn-a>ãƒ­ãƒƒã‚¯è§£é™¤</button></div></div></div>';
}
function renderConfirmDeleteMember(){
  var m=S.confirmDelMember;if(!m)return"";
  var mName="";for(var i=0;i<S.members.length;i++){if(S.members[i].id===m){mName=S.members[i].name;break;}}
  var tCount=S.tasks.filter(function(t){return t.assignee===mName;}).length;
  return '<div class="overlay" style="z-index:1100" onclick="window._cancelRm()"><div class="mbox" onclick="event.stopPropagation()" style="width:min(400px,88vw);text-align:center"><div style="width:56px;height:56px;border-radius:16px;background:#FEE2E2;display:flex;align-items:center;justify-content:center;font-size:28px;margin:0 auto 16px" data-del-bg>âš ï¸</div><h2 style="font-size:18px;font-weight:700;margin-bottom:8px" data-tx>ãƒ¡ãƒ³ãƒãƒ¼ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ</h2><p style="font-size:13px;color:#64748B;line-height:1.7" data-txs"><strong style="color:#1E293B">'+esc(mName)+'</strong> ã‚’å‰Šé™¤ã—ã¾ã™ã€‚'+(tCount>0?'<br>ã“ã®ãƒ¡ãƒ³ãƒãƒ¼ã«ç´ã¥ã <strong style="color:#DC2626">'+tCount+' ä»¶ã®ã‚¿ã‚¹ã‚¯</strong>ã®æ‹…å½“è€…ãŒç©ºã«ãªã‚Šã¾ã™ã€‚':'')+'</p><div style="display:flex;gap:10px;margin-top:20px"><button class="btn" onclick="window._cancelRm()" style="flex:1;padding:10px;border-radius:10px;border:1.5px solid #E2E8F0;background:#fff;color:#64748B;font-size:13px" data-btn-n>ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button class="btn" onclick="window._confirmRm()" style="flex:1;padding:10px;border-radius:10px;background:#DC2626;color:#fff;font-size:13px">å‰Šé™¤ã™ã‚‹</button></div></div></div>';
}
function renderSectionModal(){
  var items="";for(var i=0;i<S.sections.length;i++){var sec=S.sections[i];var tCount=S.tasks.filter(function(t){return t.section_id===sec.id;}).length;items+='<div style="display:flex;align-items:center;gap:10px;padding:10px 14px;background:#FAFBFC;border-radius:10px;border:1px solid #F1F5F9" data-card><div style="width:4px;height:28px;border-radius:2px;background:'+sec.color+';flex-shrink:0"></div><div style="flex:1;min-width:0"><div style="font-size:13px;font-weight:600" data-tx>'+esc(sec.name)+'</div><div style="font-size:10px;color:#94A3B8;margin-top:1px" data-txm>'+tCount+' ã‚¿ã‚¹ã‚¯</div></div><button class="btn" onclick="window._rmSec(\''+escA(sec.id)+'\')" style="width:24px;height:24px;border-radius:6px;background:#FEE2E2;font-size:12px;display:flex;align-items:center;justify-content:center;color:#DC2626;padding:0;flex-shrink:0">Ã—</button></div>';}
  var colorBtns="";for(var ci=0;ci<SEC_COLORS.length;ci++){colorBtns+='<button class="btn" onclick="document.getElementById(\'f-seccolor\').value=\''+SEC_COLORS[ci]+'\';this.parentNode.querySelectorAll(\'button\').forEach(function(b){b.style.outline=\'none\'});this.style.outline=\'3px solid #1E293B\'" style="width:28px;height:28px;border-radius:50%;background:'+SEC_COLORS[ci]+';padding:0'+(ci===0?';outline:3px solid #1E293B':'')+'"></button>';}
  return '<div class="overlay" onclick="window._closeM()"><div class="mbox" onclick="event.stopPropagation()"><div class="mhdr"><h2 class="mtitle">ã‚»ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†</h2><button class="mclose" onclick="window._closeM()">Ã—</button></div><div style="display:flex;flex-direction:column;gap:8px;margin-bottom:20px;max-height:240px;overflow-y:auto">'+(items||'<p style="font-size:13px;color:#94A3B8;text-align:center;padding:16px" data-txm>ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“</p>')+'</div><div style="border-top:1px solid #F1F5F9;padding-top:16px"><p style="font-size:12px;font-weight:600;color:#64748B;margin-bottom:10px" data-txs>æ–°ã—ã„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ </p><div style="display:flex;gap:8px;margin-bottom:10px;align-items:center"><input class="fi" id="f-newsec" placeholder="ã‚»ã‚¯ã‚·ãƒ§ãƒ³å" onkeydown="if(event.key===\'Enter\')window._addSec()" style="flex:1"><input type="hidden" id="f-seccolor" value="'+SEC_COLORS[0]+'"><button class="btn" onclick="window._addSec()" style="padding:10px 20px;border-radius:10px;background:#1E293B;color:#fff;font-size:13px;white-space:nowrap" data-btn-a>è¿½åŠ </button></div><div style="display:flex;gap:6px;align-items:center"><span style="font-size:11px;color:#94A3B8;margin-right:4px" data-txm>è‰²:</span>'+colorBtns+'</div></div></div></div>';
}

// â”€â”€â”€ ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¤ãƒ™ãƒ³ãƒˆ â”€â”€â”€
window._toggleDark=function(){S.dark=!S.dark;document.body.classList.toggle("dark",S.dark);try{localStorage.setItem("tb_dark",S.dark?"1":"0");}catch(e){}render();};
window._openTask=function(){S.clickSecId=null;S.clickStartDate=null;S.eTask=null;S.modal="task";render();};
window._editT=function(id){S.clickSecId=null;S.clickStartDate=null;for(var i=0;i<S.tasks.length;i++){if(S.tasks[i].id===id){S.eTask=S.tasks[i];break;}}S.modal="task";S.taskComments=[];S.commentsLoading=true;render();loadComments(id);};
window._dupT=function(id){
  var orig=null;for(var i=0;i<S.tasks.length;i++){if(S.tasks[i].id===id){orig=S.tasks[i];break;}}if(!orig)return;
  var p={title:orig.title+" (ã‚³ãƒ”ãƒ¼)",assignee:orig.assignee,start_date:orig.start_date,due_date:orig.due_date,status:"not_started",description:orig.description||"",section_id:orig.section_id||null};
  apiFetch("tasks",{method:"POST",body:JSON.stringify(p)}).then(function(){showToast("ã‚¿ã‚¹ã‚¯ã‚’è¤‡è£½ã—ã¾ã—ãŸ");S.modal=null;S.eTask=null;return loadData(true);}).catch(function(e){showToast("è¤‡è£½ã«å¤±æ•—ã—ã¾ã—ãŸ","err");console.error(e);});
};
window._postComment=function(){
  if(!S.eTask)return;
  var bodyEl=document.getElementById("f-cm-body");var authorEl=document.getElementById("f-cm-author");
  var body=bodyEl?bodyEl.value.trim():"";var author=authorEl?authorEl.value:"";
  if(!body||!author)return;
  apiFetch("comments",{method:"POST",body:JSON.stringify({task_id:S.eTask.id,author:author,body:body})}).then(function(){if(bodyEl)bodyEl.value="";loadComments(S.eTask.id);}).catch(function(e){showToast("ã‚³ãƒ¡ãƒ³ãƒˆã®æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ","err");console.error(e);});
};
window._openMember=function(){if(S.memberUnlocked){S.modal="member";render();}else{S.passError=false;S.modal="password";render();}};
window._checkPass=function(){var inp=document.getElementById("f-pass");var val=inp?inp.value:"";if(val===MEMBER_PASS){S.memberUnlocked=true;S.passError=false;S.modal="member";render();}else{S.passError=true;render();}};
window._cancelRm=function(){S.confirmDelMember=null;render();};
window._confirmRm=function(){var id=S.confirmDelMember;if(!id)return;S.confirmDelMember=null;apiFetch("members?id=eq."+id,{method:"DELETE"}).then(function(){showToast("ãƒ¡ãƒ³ãƒãƒ¼ã‚’å‰Šé™¤ã—ã¾ã—ãŸ");return loadData(true);}).then(function(){S.modal="member";render();}).catch(function(e){showToast("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ","err");console.error(e);});};
window._openSec=function(){S.modal="section";render();};
window._closeM=function(){S.modal=null;S.eTask=null;S.clickSecId=null;S.clickStartDate=null;S.memberUnlocked=false;S.passError=false;S.confirmDelMember=null;render();};
window._setV=function(v){S.view=v;render();};
window._fA=function(v){S.fA=S.fA===v?null:v;render();};
window._fS=function(v){S.fS=S.fS===v?null:v;render();};
window._fSec=function(v){S.fSec=S.fSec===v?null:v;render();};
window._saveT=function(){var el=document.getElementById("f-title");var title=el?el.value.trim():"";if(!title)return;var secVal=document.getElementById("f-section").value;var p={title:title,assignee:document.getElementById("f-assignee").value,start_date:document.getElementById("f-start").value,due_date:document.getElementById("f-due").value,status:document.getElementById("f-status").value,description:document.getElementById("f-desc").value,section_id:secVal||null};var btn=document.getElementById("btn-save");if(btn){btn.textContent="ä¿å­˜ä¸­...";btn.disabled=true;}var pr=S.eTask?apiFetch("tasks?id=eq."+S.eTask.id,{method:"PATCH",body:JSON.stringify(Object.assign(p,{updated_at:new Date().toISOString()}))}):apiFetch("tasks",{method:"POST",body:JSON.stringify(p)});pr.then(function(){showToast(S.eTask?"ã‚¿ã‚¹ã‚¯ã‚’æ›´æ–°ã—ã¾ã—ãŸ":"ã‚¿ã‚¹ã‚¯ã‚’ä½œæˆã—ã¾ã—ãŸ");S.modal=null;S.eTask=null;S.clickSecId=null;S.clickStartDate=null;return loadData(true);}).catch(function(e){showToast("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ","err");console.error(e);render();});};
window._delT=function(id){apiFetch("tasks?id=eq."+id,{method:"DELETE"}).then(function(){showToast("ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã—ãŸ");S.modal=null;S.eTask=null;return loadData(true);}).catch(function(e){showToast("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ","err");console.error(e);});};
window._addM=function(){var inp=document.getElementById("f-newmember");var name=inp?inp.value.trim():"";if(!name)return;for(var i=0;i<S.members.length;i++){if(S.members[i].name===name)return;}apiFetch("members",{method:"POST",body:JSON.stringify({name:name})}).then(function(){showToast(name+" ã‚’è¿½åŠ ã—ã¾ã—ãŸ");return loadData(true);}).then(function(){S.modal="member";render();}).catch(function(e){showToast("è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ","err");console.error(e);});};
window._rmM=function(id){S.confirmDelMember=id;render();};
window._addSec=function(){var inp=document.getElementById("f-newsec");var name=inp?inp.value.trim():"";if(!name)return;var color=document.getElementById("f-seccolor").value||SEC_COLORS[0];var order=S.sections.length;apiFetch("sections",{method:"POST",body:JSON.stringify({name:name,color:color,sort_order:order})}).then(function(){showToast(name+" ã‚’è¿½åŠ ã—ã¾ã—ãŸ");return loadData(true);}).then(function(){S.modal="section";render();}).catch(function(e){showToast("è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ","err");console.error(e);});};
window._rmSec=function(id){apiFetch("sections?id=eq."+id,{method:"DELETE"}).then(function(){showToast("ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤ã—ã¾ã—ãŸ");return loadData(true);}).then(function(){S.modal="section";render();}).catch(function(e){showToast("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ","err");console.error(e);});};
try{if(localStorage.getItem("tb_dark")==="1"){S.dark=true;document.body.classList.add("dark");}}catch(e){}
if(SUPABASE_URL&&SUPABASE_ANON_KEY){loadData(false);setInterval(function(){loadData(true);},5000);}else{S.loading=false;render();}
})();
</script>
</body>
</html>
